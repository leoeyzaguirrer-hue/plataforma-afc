<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>M√≥dulo 1: Operacionalizaci√≥n de la Conducta</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Space+Mono:wght@400;700&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
<style>
/* ===== #1 DARK MODE + THEME SYSTEM ===== */
:root,[data-theme="light"]{
--bg:#e8f4f8;--bg2:#f0f7fa;--card:#ffffff;--card2:#f8fbfc;
--gold:#d4950a;--gold-b:#f0b429;--gold-d:#a87608;--gold-g:rgba(212,149,10,0.07);
--green:#16a34a;--green-b:#22c55e;--green-g:rgba(22,163,74,0.07);
--red:#dc2626;--red-g:rgba(220,38,38,0.06);
--teal:#0e7490;--teal-b:#0891b2;--teal-g:rgba(14,116,144,0.05);
--purple:#7c3aed;--purple-g:rgba(124,58,237,0.06);
--text:#2c4a56;--dim:#6b8a97;--bright:#1a3340;
--border:rgba(14,116,144,0.12);--border2:rgba(14,116,144,0.06);
--r:16px;--rs:10px;
--shadow:0 2px 12px rgba(0,0,0,0.05);--shadow2:0 4px 24px rgba(0,0,0,0.08);
--overlay:rgba(255,255,255,0.88);--overlay2:rgba(255,255,255,0.92);
/* #1 Stage intensity colors */
--stA:#e0f2fe;--stA-b:#0ea5e9;--stA-t:#0c4a6e;
--stB:#fef3c7;--stB-b:#f59e0b;--stB-t:#78350f;
--stC:#fce7f3;--stC-b:#ec4899;--stC-t:#831843;
--stD:#ede9fe;--stD-b:#8b5cf6;--stD-t:#4c1d95;
}
[data-theme="dark"]{
--bg:#0f1a1e;--bg2:#162228;--card:#1a2c34;--card2:#213840;
--gold:#f0b429;--gold-b:#fbbf24;--gold-d:#fcd34d;--gold-g:rgba(240,180,41,0.1);
--green:#22c55e;--green-b:#4ade80;--green-g:rgba(34,197,94,0.1);
--red:#f87171;--red-g:rgba(248,113,113,0.1);
--teal:#22d3ee;--teal-b:#67e8f9;--teal-g:rgba(34,211,238,0.08);
--purple:#a78bfa;--purple-g:rgba(167,139,250,0.1);
--text:#c4dce6;--dim:#7a9aaa;--bright:#e8f4f8;
--border:rgba(34,211,238,0.12);--border2:rgba(34,211,238,0.06);
--shadow:0 2px 12px rgba(0,0,0,0.2);--shadow2:0 4px 24px rgba(0,0,0,0.3);
--overlay:rgba(15,26,30,0.92);--overlay2:rgba(15,26,30,0.95);
--stA:#0c3547;--stA-b:#38bdf8;--stA-t:#bae6fd;
--stB:#3d2e0a;--stB-b:#fbbf24;--stB-t:#fef3c7;
--stC:#3b0e2a;--stC-b:#f472b6;--stC-t:#fce7f3;
--stD:#2e1a5e;--stD-b:#a78bfa;--stD-t:#ede9fe;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
/* #24 ACCESSIBILITY focus */
:focus-visible{outline:3px solid var(--gold);outline-offset:2px;border-radius:4px}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:17px;line-height:1.65;transition:background .35s,color .35s}
#ptc{position:fixed;inset:0;z-index:0;pointer-events:none}

/* ===== LAYOUT ===== */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;z-index:1}
.top{display:flex;align-items:center;padding:12px 16px;gap:10px;background:var(--overlay);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--border);flex-shrink:0;z-index:10;transition:background .3s}
.top-back{width:38px;height:38px;border-radius:50%;background:var(--bg);border:1px solid var(--border);color:var(--teal);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;transition:all .2s}
.top-back:hover{background:var(--teal-g);border-color:var(--teal)}
.top-back svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
.top-t{font-family:'Fraunces',serif;font-size:15px;font-weight:600;color:var(--teal);line-height:1.2}
.top-s{font-size:11.5px;color:var(--dim)}
.top-prog{margin-left:auto;display:flex;align-items:center;gap:6px}
.top-prog-bar{width:56px;height:5px;border-radius:3px;background:var(--border);overflow:hidden}
.top-prog-fill{height:100%;background:var(--gold);border-radius:3px;transition:width .5s ease}
.top-prog-txt{font-family:'Space Mono',monospace;font-size:10px;color:var(--dim)}
/* #6 Dark toggle */
.top-dm{width:34px;height:34px;border-radius:50%;background:var(--bg);border:1px solid var(--border);color:var(--dim);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;transition:all .2s;margin-left:4px;flex-shrink:0}
.top-dm:hover{color:var(--gold);border-color:var(--gold)}
.cnt{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px 16px 110px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.cnt::-webkit-scrollbar{width:3px}.cnt::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.bot{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom));background:var(--overlay2);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid var(--border2);z-index:10;display:flex;gap:10px;transition:background .3s}

/* ===== BUTTONS ===== */
.btn{flex:1;padding:15px 20px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:16px;font-weight:600;border:none;cursor:pointer;transition:all .2s;text-align:center}
.btn:active{transform:scale(0.97)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-b));color:#fff;box-shadow:0 4px 16px rgba(212,149,10,0.2)}
.btn-gold:disabled{opacity:0.35;pointer-events:none}
.btn-ghost{background:var(--card);color:var(--text);border:1px solid var(--border);flex:none;padding:15px 18px}
.btn-green{background:linear-gradient(135deg,var(--green),var(--green-b));color:#fff;box-shadow:0 4px 16px rgba(22,163,74,0.2)}
.btn-teal{background:linear-gradient(135deg,var(--teal),var(--teal-b));color:#fff}
.btn-sm{flex:none;padding:10px 16px;font-size:14px;border-radius:8px}
.btn-icon{flex:none;width:44px;height:44px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:var(--rs);font-size:18px}

/* ===== CARDS ===== */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:16px;box-shadow:var(--shadow);transition:background .3s,border .3s}
.tag{font-family:'Space Mono',monospace;font-size:10.5px;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.tag svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
.tag.teal{color:var(--teal)}.tag.gold{color:var(--gold-d)}.tag.green{color:var(--green)}.tag.purple{color:var(--purple)}
.card-title{font-family:'Fraunces',serif;font-size:21px;font-weight:700;color:var(--bright);margin-bottom:8px;line-height:1.3}
.card-desc{font-size:15px;color:var(--dim);margin-bottom:14px;line-height:1.6}
.th{font-size:15.5px;color:var(--text);line-height:1.75;margin-bottom:12px}
.th b,.th strong{color:var(--bright)}
.hl{background:var(--gold-g);border-left:3px solid var(--gold);padding:14px 16px;border-radius:0 var(--rs) var(--rs) 0;margin:14px 0;font-size:14.5px;color:var(--bright);line-height:1.65}
.hl em{color:var(--gold-d);font-style:normal;font-weight:600}
.ex-box{background:var(--teal-g);border:1px solid rgba(14,116,144,0.1);border-radius:var(--rs);padding:14px 16px;margin:14px 0}
.ex-label{font-size:10.5px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.ex-box p{font-size:14px;color:var(--text);margin:0;line-height:1.65}

/* ===== #4 ACCORDION THEORY ===== */
.accord{border:1px solid var(--border);border-radius:var(--rs);margin-bottom:10px;overflow:hidden;background:var(--card);transition:all .3s}
.accord-head{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;-webkit-user-select:none;user-select:none}
.accord-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.accord-title{font-weight:600;font-size:15px;color:var(--bright);flex:1}
.accord-arrow{font-size:12px;color:var(--dim);transition:transform .3s}
.accord.open .accord-arrow{transform:rotate(180deg)}
.accord-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
.accord.open .accord-body{max-height:1200px}
.accord-inner{padding:0 16px 16px}

/* ===== #3 GLOBAL PROGRESS RING ===== */
.prog-ring{display:flex;align-items:center;justify-content:center;position:relative}
.prog-ring svg{transform:rotate(-90deg)}
.prog-ring-txt{position:absolute;font-family:'Space Mono',monospace;font-size:20px;font-weight:700;color:var(--bright)}

/* ===== HOME ===== */
.home-header{text-align:center;padding:20px 0 10px}
.home-icon{width:80px;height:80px;background:linear-gradient(135deg,var(--gold),var(--gold-b));border-radius:22px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;box-shadow:0 8px 32px rgba(212,149,10,0.18)}
.home-icon svg{width:44px;height:44px;stroke:#fff;fill:none;stroke-width:1.8}
.home-title{font-family:'Fraunces',serif;font-size:27px;font-weight:700;color:var(--bright);margin-bottom:6px}
.home-desc{font-size:15px;color:var(--dim);max-width:360px;margin:0 auto 16px}
.home-stats{display:flex;justify-content:center;gap:28px;margin-bottom:16px}
.home-stat b{font-family:'Space Mono',monospace;font-size:22px;color:var(--teal);display:block}
.home-stat span{font-size:10.5px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.sec-title{font-family:'Fraunces',serif;font-size:13px;color:var(--gold-d);text-transform:uppercase;letter-spacing:1.5px;margin:18px 0 12px}

/* ===== #7 LEVEL CARDS (better stage pills) ===== */
.lv-card{display:flex;align-items:center;gap:14px;background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:10px;cursor:pointer;transition:all .25s;box-shadow:var(--shadow);position:relative;overflow:hidden}
.lv-card::after{content:'';position:absolute;bottom:0;left:0;height:3px;width:0;background:var(--green);transition:width .4s}
.lv-card.done::after{width:100%}
.lv-card:active{transform:scale(0.98)}
.lv-card.locked{opacity:0.4;pointer-events:none}
.lv-card.done{border-color:rgba(22,163,74,0.2)}
.lv-num{width:44px;height:44px;border-radius:14px;color:#fff;font-family:'Space Mono',monospace;font-size:17px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.lv-card:nth-child(odd) .lv-num{background:linear-gradient(135deg,var(--teal),var(--teal-b))}
.lv-card:nth-child(even) .lv-num{background:linear-gradient(135deg,var(--gold),var(--gold-b))}
.lv-card.done .lv-num{background:linear-gradient(135deg,var(--green),var(--green-b))!important}
.lv-name{font-weight:600;font-size:15.5px;color:var(--bright);margin-bottom:2px}
.lv-sub{font-size:12px;color:var(--dim);display:flex;align-items:center;gap:6px}
.lv-sub .stars{color:var(--gold)}
.lv-arrow{color:var(--dim);margin-left:auto;font-size:18px}

/* ===== #1 STAGE CARDS WITH INTENSITY ===== */
.stage-scroll{display:flex;gap:10px;overflow-x:auto;padding:2px 0 12px;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none}
.stage-scroll::-webkit-scrollbar{display:none}
.st-card{min-width:140px;padding:14px;border-radius:14px;border:2px solid var(--border);background:var(--card);cursor:pointer;transition:all .25s;flex-shrink:0;position:relative}
.st-card.active{transform:scale(1.03)}
.st-card.locked{opacity:0.35;pointer-events:none}
.st-card.done .st-check{display:flex}
.st-check{display:none;position:absolute;top:8px;right:8px;width:20px;height:20px;border-radius:50%;background:var(--green);color:#fff;font-size:11px;align-items:center;justify-content:center}
.st-label{font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.st-name{font-weight:600;font-size:14px;color:var(--bright);margin-bottom:2px}
.st-sub{font-size:11.5px;color:var(--dim)}
.st-card[data-stage="A"]{border-color:rgba(14,165,233,0.2)}.st-card[data-stage="A"].active{background:var(--stA);border-color:var(--stA-b)}.st-card[data-stage="A"] .st-label{color:var(--stA-b)}
.st-card[data-stage="B"]{border-color:rgba(245,158,11,0.2)}.st-card[data-stage="B"].active{background:var(--stB);border-color:var(--stB-b)}.st-card[data-stage="B"] .st-label{color:var(--stB-b)}
.st-card[data-stage="C"]{border-color:rgba(236,72,153,0.2)}.st-card[data-stage="C"].active{background:var(--stC);border-color:var(--stC-b)}.st-card[data-stage="C"] .st-label{color:var(--stC-b)}
.st-card[data-stage="D"]{border-color:rgba(139,92,246,0.2)}.st-card[data-stage="D"].active{background:var(--stD);border-color:var(--stD-b)}.st-card[data-stage="D"] .st-label{color:var(--stD-b)}

/* ===== #5 PATIENT FILE CARDS ===== */
.patient{background:var(--card);border:1.5px solid rgba(212,149,10,0.2);border-radius:var(--r);padding:18px;margin-bottom:16px;box-shadow:0 3px 16px rgba(212,149,10,0.06);position:relative}
.patient-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.patient-avatar{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:#fff;flex-shrink:0}
.patient-avatar.f{background:linear-gradient(135deg,#ec4899,#f472b6)}
.patient-avatar.m{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
.patient-avatar.c{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
.patient-meta{flex:1}
.patient-name{font-family:'Fraunces',serif;font-size:17px;font-weight:700;color:var(--bright)}
.patient-age{font-size:12.5px;color:var(--dim)}
.patient-badge{font-family:'Space Mono',monospace;font-size:9.5px;text-transform:uppercase;letter-spacing:1px;padding:4px 10px;border-radius:6px;background:rgba(212,149,10,0.08);color:var(--gold-d);border:1px solid rgba(212,149,10,0.15)}
.patient-quote{font-size:15px;font-style:italic;color:var(--text);line-height:1.65;padding:12px 14px;background:var(--bg2);border-radius:var(--rs);border-left:3px solid var(--gold);margin-top:4px}

/* ===== EXERCISE COMPONENTS ===== */
/* #20 Smooth transitions */
.ex-wrap{transition:opacity .3s ease,transform .3s ease}
.ex-wrap.exit{opacity:0;transform:translateX(-20px)}
.ex-wrap.enter{opacity:0;transform:translateX(20px)}

/* Pips */
.ex-prog{display:flex;align-items:center;gap:3px;justify-content:center;margin-bottom:14px;flex-wrap:wrap}
.ex-pip{width:18px;height:5px;border-radius:3px;background:var(--border);transition:all .35s}
.ex-pip.done{background:var(--green)}
.ex-pip.fail{background:var(--red)}
.ex-pip.current{background:var(--gold);width:26px}

/* Question */
.q-num{font-family:'Space Mono',monospace;font-size:10.5px;color:var(--gold-d);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:flex;align-items:center;gap:8px}
/* #21 Timer */
.q-timer{margin-left:auto;display:flex;align-items:center;gap:4px;font-size:11px;color:var(--dim);background:var(--bg);padding:3px 8px;border-radius:6px}
.q-timer.warn{color:var(--red);animation:pulse .5s infinite alternate}
.q-text{font-size:17px;font-weight:500;color:var(--bright);margin-bottom:16px;line-height:1.55}
/* #10 Instructions */
.q-instr{font-size:13px;color:var(--dim);margin-bottom:14px;padding:10px 14px;background:var(--bg2);border-radius:var(--rs);display:flex;align-items:flex-start;gap:8px}
.q-instr svg{width:16px;height:16px;stroke:var(--teal);flex-shrink:0;margin-top:2px}

/* Options */
.opt{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:1.5px solid var(--border);border-radius:var(--rs);margin-bottom:8px;cursor:pointer;transition:all .25s;-webkit-user-select:none;user-select:none}
.opt:active{transform:scale(0.98)}
.opt.picked{border-color:var(--gold);background:var(--gold-g)}
.opt.correct{border-color:var(--green);background:var(--green-g)}
.opt.wrong{border-color:var(--red);background:var(--red-g)}
.opt.reveal{border-color:var(--green);background:var(--green-g);opacity:.6}
.opt.disabled{pointer-events:none}
.opt-mark{width:24px;height:24px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:700;color:var(--dim);transition:all .2s}
.opt.picked .opt-mark{border-color:var(--gold);color:var(--gold-d);background:var(--gold-g)}
.opt.correct .opt-mark{border-color:var(--green);color:#fff;background:var(--green)}
.opt.wrong .opt-mark{border-color:var(--red);color:#fff;background:var(--red)}
.opt-mark.chk{border-radius:6px}
.opt-txt{font-size:15px;color:var(--text);line-height:1.5;flex:1}

/* TF */
.tf-wrap{display:flex;gap:10px;margin-bottom:8px}
.tf-btn{flex:1;padding:18px;border:2px solid var(--border);border-radius:var(--rs);font-size:17px;font-weight:600;text-align:center;cursor:pointer;transition:all .2s;background:var(--card);color:var(--text)}
.tf-btn:active{transform:scale(0.97)}
.tf-btn.correct{border-color:var(--green);background:var(--green-g);color:var(--green)}
.tf-btn.wrong{border-color:var(--red);background:var(--red-g);color:var(--red)}
.tf-btn.disabled{pointer-events:none}

/* Classify drag */
.cl-item{background:var(--card);border:1px solid var(--border);border-radius:var(--rs);padding:14px;margin-bottom:10px}
.cl-item-text{font-size:15px;color:var(--bright);margin-bottom:10px;font-style:italic}
.cl-cats{display:flex;gap:6px;flex-wrap:wrap}
.cl-cat{padding:9px 16px;border-radius:8px;font-size:13.5px;font-weight:500;border:1.5px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all .2s}
.cl-cat:active{transform:scale(0.96)}
.cl-cat.correct{border-color:var(--green);background:var(--green-g);color:var(--green)}
.cl-cat.wrong{border-color:var(--red);background:var(--red-g);color:var(--red)}
.cl-cat.disabled{pointer-events:none}

/* #11 Order with undo */
.ord-pool{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.ord-item{padding:10px 16px;border-radius:8px;font-size:14px;border:1.5px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all .2s}
.ord-item:active{transform:scale(0.96)}
.ord-item.placed{opacity:0.2;pointer-events:none}
.ord-seq{min-height:48px;border:2px dashed var(--border);border-radius:var(--rs);padding:10px;display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;transition:border-color .3s}
.ord-seq.over{border-color:var(--gold)}
.ord-placed{padding:8px 14px;border-radius:8px;font-size:13px;background:var(--teal-g);border:1px solid rgba(14,116,144,0.12);color:var(--teal);display:flex;align-items:center;gap:6px;cursor:pointer}
.ord-placed:hover{opacity:.7}
.ord-placed .ord-n{font-family:'Space Mono',monospace;font-size:11px;font-weight:700}
.ord-placed.correct{background:var(--green-g);border-color:rgba(22,163,74,0.15);color:var(--green)}
.ord-placed.wrong{background:var(--red-g);border-color:rgba(220,38,38,0.15);color:var(--red)}
.ord-undo{font-size:12px;color:var(--dim);cursor:pointer;padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:var(--card);margin-left:auto;display:none;align-items:center;gap:4px}
.ord-undo.show{display:flex}

/* #8 Fill-in-blank */
.fib-text{font-size:15px;color:var(--text);line-height:2.2;margin-bottom:12px}
.fib-blank{display:inline-block;min-width:120px;padding:4px 12px;border-bottom:2px dashed var(--gold);color:var(--gold-d);font-weight:600;cursor:pointer;transition:all .2s;background:var(--gold-g);border-radius:4px 4px 0 0;font-size:14px}
.fib-blank.filled{border-bottom-style:solid;background:rgba(14,116,144,0.06);color:var(--teal)}
.fib-blank.correct{border-color:var(--green);color:var(--green);background:var(--green-g)}
.fib-blank.wrong{border-color:var(--red);color:var(--red);background:var(--red-g)}
.fib-options{display:flex;flex-wrap:wrap;gap:6px;padding:12px;background:var(--bg2);border-radius:var(--rs);margin-bottom:12px}
.fib-opt{padding:8px 14px;border-radius:8px;font-size:13px;border:1.5px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all .2s}
.fib-opt:active{transform:scale(0.95)}
.fib-opt.used{opacity:0.25;pointer-events:none}
.fib-opt.wrong-src{border-color:var(--red);background:var(--red-g)}

/* #14 Speed mode */
.speed-bar{height:6px;background:var(--border);border-radius:3px;margin-bottom:14px;overflow:hidden}
.speed-fill{height:100%;background:var(--green);border-radius:3px;transition:width linear}
.speed-fill.warn{background:var(--gold)}
.speed-fill.crit{background:var(--red)}
.speed-stat{text-align:center;margin-bottom:10px}
.speed-stat b{font-family:'Space Mono',monospace;font-size:28px;color:var(--bright)}
.speed-stat span{font-size:12px;color:var(--dim);display:block}

/* ===== #2 FEEDBACK + MICRO-ANIMATIONS ===== */
.fb{padding:14px 16px;border-radius:var(--rs);margin-top:12px;font-size:14px;line-height:1.6;display:none;position:relative;overflow:hidden}
.fb.show{display:block;animation:fbSlide .35s ease}
@keyframes fbSlide{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fb.ok{background:var(--green-g);border:1px solid rgba(22,163,74,0.18);color:var(--green)}
.fb.fail{background:var(--red-g);border:1px solid rgba(220,38,38,0.13);color:var(--red)}
[data-theme="dark"] .fb.ok{color:var(--green-b)}
[data-theme="dark"] .fb.fail{color:#fca5a5}
.fb b{color:var(--bright);display:block;margin-bottom:4px}
/* #12 Hint in feedback */
.fb-hint{margin-top:8px;padding:8px 12px;background:rgba(124,58,237,0.06);border-radius:6px;font-size:13px;color:var(--purple);display:none}
.fb-hint.show{display:block}

/* Confetti */
.confetti-wrap{position:fixed;top:0;left:0;right:0;height:50vh;pointer-events:none;z-index:999;overflow:hidden}
.confetti{position:absolute;width:8px;height:8px;border-radius:2px;animation:confDrop 1.2s ease-out forwards}
@keyframes confDrop{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(50vh) rotate(720deg);opacity:0}}
/* Shake */
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
.shake{animation:shake .4s ease}
/* Pulse */
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(22,163,74,0.3)}70%{box-shadow:0 0 0 12px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
.pulse-ok{animation:pulse .6s ease}
/* #23 Skeleton */
.skel{background:linear-gradient(90deg,var(--border) 25%,var(--border2) 50%,var(--border) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ===== #15 SVG DIAGRAMS ===== */
.diagram{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin:16px 0;text-align:center;overflow-x:auto}
.diagram svg{max-width:100%;height:auto}
.diagram-label{font-size:11px;color:var(--dim);margin-top:8px;font-style:italic}

/* ===== SUMMARY ===== */
.sum-circle{width:130px;height:130px;border-radius:50%;border:5px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:20px auto;transition:border-color .5s}
.sum-circle.great{border-color:var(--green)}.sum-circle.ok{border-color:var(--gold)}.sum-circle.low{border-color:var(--red)}
.sum-score{font-family:'Space Mono',monospace;font-size:40px;font-weight:700;color:var(--bright)}
.sum-total{font-size:13px;color:var(--dim)}
.sum-msg{text-align:center;font-family:'Fraunces',serif;font-size:22px;font-weight:600;color:var(--bright);margin:12px 0 4px}
.sum-sub{text-align:center;font-size:14px;color:var(--dim);margin-bottom:16px}
/* #19 Error review */
.review-card{background:var(--red-g);border:1px solid rgba(220,38,38,0.1);border-radius:var(--rs);padding:14px;margin-bottom:8px}
.review-q{font-size:14px;color:var(--bright);margin-bottom:4px}
.review-a{font-size:13px;color:var(--green)}
/* #13 Cheatsheet */
.cheat{background:var(--card);border:1.5px solid var(--gold);border-radius:var(--r);padding:18px;margin-top:16px}
.cheat-title{font-family:'Fraunces',serif;font-size:16px;font-weight:700;color:var(--gold-d);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.cheat-item{font-size:13.5px;color:var(--text);padding:6px 0;border-bottom:1px solid var(--border2)}

/* Workshop banner */
.ws-banner{background:linear-gradient(135deg,var(--gold-g),var(--teal-g));border:1.5px solid rgba(212,149,10,0.18);border-radius:var(--r);padding:16px 18px;margin-bottom:18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .25s}
.ws-banner:active{transform:scale(0.98)}
.ws-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--gold),var(--gold-b));border-radius:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 14px rgba(212,149,10,0.15)}
.ws-icon svg{width:26px;height:26px;stroke:#fff;fill:none;stroke-width:1.8}

/* ===== ANIMATIONS ===== */
@keyframes up{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:up .4s ease forwards}
.d1{animation-delay:.07s;opacity:0}.d2{animation-delay:.14s;opacity:0}.d3{animation-delay:.21s;opacity:0}

/* ===== #24 RESPONSIVE ===== */
@media(min-width:768px){
html{font-size:18px}
.screen{max-width:700px;margin:0 auto;left:50%;transform:translateX(-50%);right:auto;width:100%;border-left:1px solid var(--border2);border-right:1px solid var(--border2)}
.top,.bot{max-width:700px;left:50%;transform:translateX(-50%);right:auto;width:100%}
.cnt{padding:28px 32px 110px}.bot{padding:14px 32px}
.card{padding:24px 28px}
.opt:hover:not(.disabled){background:var(--teal-g);border-color:rgba(14,116,144,0.18)}
.tf-btn:hover:not(.disabled){background:var(--teal-g)}
.lv-card:hover:not(.locked){border-color:rgba(14,116,144,0.22);box-shadow:var(--shadow2)}
.btn:hover{filter:brightness(1.05)}
}
@media(min-width:1024px){
html{font-size:18.5px}
.screen{max-width:780px;box-shadow:0 0 80px rgba(0,0,0,0.05)}
.top,.bot{max-width:780px}
.cnt{padding:32px 40px 120px}.bot{padding:16px 40px}
.card{padding:28px 36px}
.home-title{font-size:34px}
}
</style>
</head>
<body>
<canvas id="ptc"></canvas>
<div class="screen" id="app" role="main" aria-label="M√≥dulo de aprendizaje"></div>
<!-- #2 Confetti container -->
<div class="confetti-wrap" id="confWrap" aria-hidden="true"></div>

<script>
// ===== PARTICLES =====
(function(){const c=document.getElementById('ptc'),x=c.getContext('2d');let ps=[];function rs(){c.width=innerWidth;c.height=innerHeight}addEventListener('resize',rs);rs();class P{constructor(){this.r()}r(){this.x=Math.random()*c.width;this.y=Math.random()*c.height;this.s=Math.random()*2.8+.8;this.sx=(Math.random()-.5)*.2;this.sy=-Math.random()*.3-.06;this.o=Math.random()*.4+.1;this.p=Math.random()*Math.PI*2;this.ps=Math.random()*.015+.005}u(){this.x+=this.sx;this.y+=this.sy;this.p+=this.ps;if(this.y<-10){this.y=c.height+10;this.x=Math.random()*c.width}}d(){const g=Math.sin(this.p)*.15+.85,a=this.o*g;x.save();x.globalAlpha=a;x.shadowBlur=this.s*3;x.shadowColor='rgba(212,149,10,0.3)';x.beginPath();x.arc(this.x,this.y,this.s,0,Math.PI*2);x.fillStyle=`rgba(222,165,30,${a})`;x.fill();x.restore()}}for(let i=0;i<20;i++)ps.push(new P);(function a(){x.clearRect(0,0,c.width,c.height);ps.forEach(p=>{p.u();p.d()});requestAnimationFrame(a)})()})();

// ===== #16 SVG ICONS =====
const ICO={
back:'<svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>',
book:'<svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
brain:'<svg viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5c0 .8-.2 1.5-.5 2.2A5 5 0 0 1 19 14a5 5 0 0 1-3 4.6V22h-4v-3.4A5 5 0 0 1 9 14a5 5 0 0 1 2.5-4.3A5 5 0 0 1 12 2z"/></svg>',
check:'<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
clip:'<svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg>',
info:'<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
flask:'<svg viewBox="0 0 24 24"><path d="M9 3h6v5l4 9H5l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>',
target:'<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
zap:'<svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
dl:'<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
moon:'<svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
sun:'<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
undo:'<svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>',
clock:'<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>'
};

// ===== #15 SVG DIAGRAMS =====
const DIAGRAMS={
triple:`<svg viewBox="0 0 360 200" xmlns="http://www.w3.org/2000/svg">
<defs><filter id="gs"><feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity=".08"/></filter></defs>
<rect x="110" y="10" width="140" height="40" rx="20" fill="var(--gold-g)" stroke="var(--gold)" stroke-width="1.5" filter="url(#gs)"/>
<text x="180" y="35" text-anchor="middle" font-family="Fraunces,serif" font-size="14" font-weight="700" fill="var(--bright)">CONDUCTA</text>
<line x1="120" y1="50" x2="60" y2="100" stroke="var(--border)" stroke-width="1.5" stroke-dasharray="4"/>
<line x1="180" y1="50" x2="180" y2="100" stroke="var(--border)" stroke-width="1.5" stroke-dasharray="4"/>
<line x1="240" y1="50" x2="300" y2="100" stroke="var(--border)" stroke-width="1.5" stroke-dasharray="4"/>
<rect x="5" y="100" width="110" height="90" rx="12" fill="var(--stA)" stroke="#0ea5e9" stroke-width="1.5" filter="url(#gs)"/>
<text x="60" y="125" text-anchor="middle" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="#0ea5e9">üèÉ MOTOR</text>
<text x="60" y="145" text-anchor="middle" font-size="10" fill="var(--text)">Acciones observables</text>
<text x="60" y="160" text-anchor="middle" font-size="9" fill="var(--dim)">Gritar, evitar, golpear</text>
<text x="60" y="175" text-anchor="middle" font-size="9" fill="var(--dim)">Llorar, correr, hablar</text>
<rect x="125" y="100" width="110" height="90" rx="12" fill="var(--stB)" stroke="#f59e0b" stroke-width="1.5" filter="url(#gs)"/>
<text x="180" y="125" text-anchor="middle" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="#f59e0b">üí≠ COGNITIVO</text>
<text x="180" y="145" text-anchor="middle" font-size="10" fill="var(--text)">Verbalizaciones</text>
<text x="180" y="160" text-anchor="middle" font-size="9" fill="var(--dim)">encubiertas e im√°genes</text>
<text x="180" y="175" text-anchor="middle" font-size="9" fill="var(--dim)">"No puedo", "Va a salir mal"</text>
<rect x="245" y="100" width="110" height="90" rx="12" fill="var(--stC)" stroke="#ec4899" stroke-width="1.5" filter="url(#gs)"/>
<text x="300" y="125" text-anchor="middle" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="#ec4899">ü´Ä FISIOL√ìGICO</text>
<text x="300" y="145" text-anchor="middle" font-size="10" fill="var(--text)">Respuestas corporales</text>
<text x="300" y="160" text-anchor="middle" font-size="9" fill="var(--dim)">Taquicardia, sudor</text>
<text x="300" y="175" text-anchor="middle" font-size="9" fill="var(--dim)">Tensi√≥n, temblor, n√°usea</text>
</svg>`,
ere:`<svg viewBox="0 0 380 120" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="arw" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="var(--gold)"/></marker><filter id="gs2"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity=".06"/></filter></defs>
<rect x="5" y="25" width="100" height="70" rx="12" fill="var(--teal-g)" stroke="var(--teal)" stroke-width="1.5" filter="url(#gs2)"/>
<text x="55" y="52" text-anchor="middle" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="var(--teal)">E ‚Üí</text>
<text x="55" y="68" text-anchor="middle" font-size="9.5" fill="var(--text)">Antecedente</text>
<text x="55" y="82" text-anchor="middle" font-size="8.5" fill="var(--dim)">E·¥Ö / EC</text>
<line x1="110" y1="60" x2="138" y2="60" stroke="var(--gold)" stroke-width="2" marker-end="url(#arw)"/>
<rect x="140" y="15" width="100" height="90" rx="12" fill="var(--gold-g)" stroke="var(--gold)" stroke-width="1.5" filter="url(#gs2)"/>
<text x="190" y="42" text-anchor="middle" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="var(--gold-d)">R</text>
<text x="190" y="58" text-anchor="middle" font-size="9.5" fill="var(--text)">Respuesta</text>
<text x="190" y="72" text-anchor="middle" font-size="8.5" fill="var(--dim)">Motor + Cogn +</text>
<text x="190" y="84" text-anchor="middle" font-size="8.5" fill="var(--dim)">Fisiol</text>
<line x1="245" y1="60" x2="273" y2="60" stroke="var(--gold)" stroke-width="2" marker-end="url(#arw)"/>
<rect x="275" y="25" width="100" height="70" rx="12" fill="var(--purple-g)" stroke="var(--purple)" stroke-width="1.5" filter="url(#gs2)"/>
<text x="325" y="52" text-anchor="middle" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="var(--purple)">‚Üí E</text>
<text x="325" y="68" text-anchor="middle" font-size="9.5" fill="var(--text)">Consecuente</text>
<text x="325" y="82" text-anchor="middle" font-size="8.5" fill="var(--dim)">R+ R- C+ C-</text>
</svg>`
};

// ===== #6 DARK MODE =====
function toggleDark(){
const h=document.documentElement;
const d=h.getAttribute('data-theme')==='dark'?'light':'dark';
h.setAttribute('data-theme',d);
localStorage.setItem('m1theme',d);
document.querySelector('.top-dm').innerHTML=d==='dark'?ICO.sun:ICO.moon;
}
(function(){const t=localStorage.getItem('m1theme');if(t)document.documentElement.setAttribute('data-theme',t)})();

// ===== #18 FULL STATE PERSISTENCE =====
const STORE_KEY='m1v2_state';
let S={
view:'home',level:null,stage:null,exIdx:0,seqIdx:0,
scores:{},errors:{},answers:{},
globalDone:0
};
function saveState(){try{localStorage.setItem(STORE_KEY,JSON.stringify(S))}catch(e){}}
function loadState(){try{const d=localStorage.getItem(STORE_KEY);if(d){const p=JSON.parse(d);Object.assign(S,p);S.view='home';S.answers={}}}catch(e){}}
loadState();

// ===== #2 CONFETTI =====
function fireConfetti(){
const w=document.getElementById('confWrap');
const colors=['#22c55e','#f0b429','#0ea5e9','#ec4899','#8b5cf6','#f97316'];
for(let i=0;i<24;i++){
const c=document.createElement('div');c.className='confetti';
c.style.left=Math.random()*100+'%';c.style.background=colors[i%colors.length];
c.style.animationDelay=Math.random()*.4+'s';c.style.width=(Math.random()*6+4)+'px';
c.style.height=(Math.random()*6+4)+'px';
w.appendChild(c);setTimeout(()=>c.remove(),1600);
}}

// ===== LEVEL DATA =====
const L={
1:{title:"¬øQu√© es Conducta?",cheat:["Conducta = actividad del organismo en interacci√≥n con su entorno","Se expresa como VERBO, no como sustantivo","Las etiquetas (ansiedad, agresividad, depresi√≥n) NO explican la conducta","Conducta privada (pensar, sentir) opera bajo los mismos principios que la p√∫blica","La regla de oro: si dos observadores no pueden verificarlo, no est√° operacionalizado"],
theory:[
{icon:'üìñ',title:'¬øQu√© es conducta?',color:'gold',body:`<p class="th"><strong>Conducta</strong> es cualquier actividad del organismo en interacci√≥n con su entorno. No es sin√≥nimo de "acci√≥n observable": incluye tambi√©n eventos privados como pensamientos, im√°genes y respuestas fisiol√≥gicas.</p><p class="th">Lo que diferencia la conducta de otros fen√≥menos biol√≥gicos es su <strong>relaci√≥n funcional</strong> con el ambiente.</p>`},
{icon:'üè∑Ô∏è',title:'Conducta ‚â† Etiqueta',color:'teal',body:`<div class="hl"><em>Principio clave:</em> La conducta siempre se expresa como <em>verbo</em>. "Gritar" es conducta; "agresividad" es una etiqueta. "Evitar salir" es conducta; "agorafobia" es una categor√≠a diagn√≥stica.</div><p class="th">Desde el An√°lisis Funcional, rechazamos las <strong>etiquetas diagn√≥sticas</strong> como explicaciones: decir que alguien "es agresivo" o "tiene ansiedad" describe un r√≥tulo, no una conducta.</p>`},
{icon:'üî¨',title:'Ejemplo pr√°ctico',color:'green',body:`<div class="ex-box"><div class="ex-label">De etiqueta a conducta</div><p><b>Etiqueta:</b> "Pedro es agresivo" ‚Üí No es conducta<br><b>Conducta:</b> "Pedro golpea la mesa y grita cuando su jefe le corrige" ‚Üí Observable, medible, en contexto</p></div>`}
],
stages:[
{id:'A',title:'¬øEs conducta o no?',sub:'Verdadero / Falso',typeLabel:'V/F r√°pido',instr:'Lee cada afirmaci√≥n y decide: ¬øes verdadera o falsa? Toca V o F.',exercises:[
{type:'tf',s:'"Pensar ¬´no voy a poder¬ª antes de un examen es una conducta."',c:true,ok:'Pensar es verbalizaci√≥n encubierta ‚Äî conducta privada que opera bajo los mismos principios de aprendizaje.',fail:'Pensar es conducta privada. Las verbalizaciones encubiertas son conducta.'},
{type:'tf',s:'"Mar√≠a es una persona ansiosa" es una descripci√≥n conductual adecuada.',c:false,ok:'"Es ansiosa" es etiqueta de rasgo, no descripci√≥n conductual. No nos dice qu√© hace.',fail:'"Es ansiosa" es etiqueta. No especifica qu√© hace Mar√≠a, cu√°ndo, ni en qu√© contexto.'},
{type:'tf',s:'"Sentir taquicardia al entrar en el metro" describe una conducta.',c:true,ok:'La taquicardia es respuesta fisiol√≥gica condicionada ‚Äî componente fisiol√≥gico de la conducta.',fail:'La taquicardia es conducta fisiol√≥gica en un contexto espec√≠fico.'},
{type:'tf',s:'"Juan tiene baja autoestima" describe una conducta.',c:false,ok:'"Baja autoestima" es etiqueta disposicional. La conducta ser√≠a lo que Juan HACE.',fail:'"Baja autoestima" es etiqueta. ¬øQu√© hace Juan? "Se dice que no vale", "rechaza invitaciones"...'},
{type:'tf',s:'"Imaginarse fracasando en una entrevista" es una conducta.',c:true,ok:'Imaginar es conducta encubierta (cognitiva). Puede funcionar como est√≠mulo antecedente.',fail:'Imaginar es conducta encubierta. Opera bajo principios de aprendizaje.'},
{type:'tf',s:'"La personalidad extrovertida explica su comportamiento social."',c:false,ok:'"Personalidad" no explica conducta ‚Äî es circular. Lo que explica son las contingencias.',fail:'La personalidad es constructo circular: "¬øpor qu√© habla mucho? Porque es extrovertida. ¬øC√≥mo sabemos? Porque habla mucho."'},
{type:'tf',s:'"Decirse repetidamente ¬´soy un in√∫til¬ª es una conducta."',c:true,ok:'Es verbalizaci√≥n encubierta con funci√≥n de est√≠mulo para otras respuestas.',fail:'Decirse algo es conducta verbal encubierta.'},
{type:'tf',s:'"La depresi√≥n es una conducta."',c:false,ok:'"Depresi√≥n" es categor√≠a diagn√≥stica que agrupa m√∫ltiples conductas (quedarse en cama, llorar, dejar actividades...).',fail:'"Depresi√≥n" agrupa diversas conductas que deben operacionalizarse por separado.'},
{type:'tf',s:'"Evitar coger el ascensor cada vez" es una conducta.',c:true,ok:'Evitar es conducta operante observable, medible, mantenida por R-.',fail:'Evitar el ascensor es conducta operante mantenida por sus consecuencias.'},
{type:'tf',s:'"Carlos tiene un problema de agresividad" describe una conducta.',c:false,ok:'Es etiqueta. La conducta: "Carlos golpea a compa√±eros en el recreo 3 veces/semana cuando le quitan el bal√≥n."',fail:'Es etiqueta. Necesitamos: ¬øqu√© hace? ¬øcu√°ndo? ¬øcon qu√© frecuencia?'}
]},
{id:'B',title:'Observable vs. Encubierta',sub:'Clasificaci√≥n',typeLabel:'Clasifica',instr:'Para cada descripci√≥n, ¬øes conducta Observable (manifiesta, que ver√≠a una c√°mara) o Encubierta (privada)?',exercises:[
{type:'classify',categories:['Observable','Encubierta'],items:[
{text:'Gritar a su pareja durante una discusi√≥n',cat:'Observable'},
{text:'Pensar "seguro que me sale mal"',cat:'Encubierta'},
{text:'Salir corriendo del aula de examen',cat:'Observable'},
{text:'Taquicardia al ver al ex en la calle',cat:'Encubierta'},
{text:'Llamar por tel√©fono a su madre 5 veces al d√≠a',cat:'Observable'},
{text:'Decirse "no valgo para nada"',cat:'Encubierta'},
{text:'Quedarse en la cama hasta las 14h',cat:'Observable'},
{text:'Nudo en el est√≥mago antes de cada reuni√≥n',cat:'Encubierta'}
]}
]},
{id:'C',title:'De etiqueta a conducta',sub:'Transformaci√≥n',typeLabel:'Elige la mejor',instr:'Elige cu√°l es la MEJOR operacionalizaci√≥n conductual de cada etiqueta.',exercises:[
{type:'single',text:'El paciente "es agresivo". ¬øMejor operacionalizaci√≥n?',opts:['Tiene un problema grave de agresividad','Golpea la mesa y grita insultos a sus compa√±eros 3 veces/semana','Su temperamento es violento por naturaleza','Presenta un trastorno explosivo intermitente'],c:1,ok:'Incluye conducta observable (golpear, gritar), medible (3 veces/semana) y contexto.',fail:'La mejor describe conducta observable, medible y contextualizada.'},
{type:'single',text:'La paciente "tiene ansiedad". ¬øMejor operacionalizaci√≥n?',opts:['Padece un trastorno de ansiedad generalizada','Sudoraci√≥n, temblor de manos y dice "me va a dar algo" al hablar en p√∫blico','Su ansiedad le impide funcionar','Es muy nerviosa desde siempre'],c:1,ok:'Incluye fisiol√≥gico (sudoraci√≥n, temblor), cognitivo ("me va a dar algo") y contexto.',fail:'La mejor describe componentes espec√≠ficos y contexto.'},
{type:'single',text:'"Es dependiente emocionalmente". ¬øMejor operacionalizaci√≥n?',opts:['Pide opini√≥n a su pareja antes de cualquier decisi√≥n y llama 8 veces/d√≠a para saber d√≥nde est√°','Tiene apego inseguro','No puede estar sola por miedo al abandono','Personalidad dependiente'],c:0,ok:'Conductas concretas con par√°metros: pedir opini√≥n (cualquier decisi√≥n), llamar (8 veces/d√≠a).',fail:'La mejor tiene conductas concretas y par√°metros cuantificados.'},
{type:'single',text:'"Tiene baja autoestima". ¬øMejor operacionalizaci√≥n?',opts:['Se valora negativamente','Rechaza invitaciones, evita opinar en reuniones y se dice "nadie quiere estar conmigo" a diario','Baja autoestima por experiencias infantiles','Necesita validaci√≥n constante'],c:1,ok:'Triple sistema: motor (rechaza, evita), cognitivo ("nadie quiere...") con par√°metro (a diario).',fail:'La mejor incluye motor, cognitivo y par√°metros.'},
{type:'single',text:'"El ni√±o es hiperactivo". ¬øMejor operacionalizaci√≥n?',opts:['Se levanta del pupitre 12 veces/hora, habla sin turno, cambia de actividad cada 2-3 min','TDAH diagnosticado que explica inquietud','Nivel de actividad superior a otros','No puede concentrarse por hiperactividad'],c:0,ok:'Conductas medibles: 12 veces/hora, sin turno, cada 2-3 min. Observables y cuantificables.',fail:'La mejor describe conductas medibles con par√°metros.'},
{type:'single',text:'"Est√° deprimida". ¬øMejor operacionalizaci√≥n?',opts:['Depresi√≥n mayor en tratamiento','Permanece en cama 14h/d√≠a, dej√≥ de quedar con amigas, llora 3-4 veces/d√≠a y dice "no merece la pena"','Tristeza cr√≥nica le impide funcionar','Estado deprimido persistente'],c:1,ok:'Motor (cama 14h, dej√≥ de quedar), fisiol√≥gico-motor (llorar 3-4/d√≠a) y cognitivo ("no merece la pena").',fail:'La mejor incluye motor, fisiol√≥gico y cognitivo con par√°metros.'}
]},
{id:'D',title:'Caso: Laura',sub:'Caso cl√≠nico',typeLabel:'Secuencia',instr:'Lee el caso y responde las preguntas en secuencia. Cada respuesta informa la siguiente.',exercises:[
{type:'seq',patient:{name:'Laura',age:'32 a√±os',gender:'f',initial:'L',badge:'Motivo: "Soy insegura"'},quote:'"Soy muy insegura, no valgo para nada, siempre me pasa lo mismo. Tengo un problema de autoestima."',questions:[
{text:'¬øCu√°l de las expresiones de Laura describe una CONDUCTA y no una etiqueta?',opts:['"Soy muy insegura"','"No valgo para nada"','"Tengo un problema de autoestima"','Ninguna ‚Äî todas son etiquetas'],c:3,fb:'Correcto. Todas son etiquetas o autoatribuciones globales. El terapeuta necesita desglosar esto en conductas concretas.',hint:'Piensa: ¬øalguna de estas frases describe algo que una c√°mara podr√≠a grabar o que se pueda contar?'},
{text:'El terapeuta pregunta: "¬øQu√© quieres decir con que no vales para nada?" Laura: "Cada vez que tengo que decidir algo, llamo a mi madre. Si no me dice qu√© hacer, me quedo bloqueada." ¬øQu√© logr√≥ el terapeuta?',opts:['Identificar la causa','Operacionalizar una etiqueta en conductas concretas','Hacer diagn√≥stico diferencial','Establecer relaci√≥n terap√©utica'],c:1,fb:'Correcto. Convirti√≥ "no valgo para nada" en conductas: llamar a la madre, quedarse bloqueada. Ahora son datos observables.',hint:'El terapeuta transform√≥ algo vago en algo que se puede observar y medir.'},
{text:'¬øQu√© deber√≠a explorar PRIMERO ahora?',opts:['Traumas infantiles','Los par√°metros: frecuencia, duraci√≥n, intensidad','Si tiene trastorno de personalidad dependiente','La relaci√≥n con la madre en profundidad'],c:1,fb:'Correcto. Siguiente paso: ¬øcu√°ntas veces/d√≠a llama? ¬øcu√°nto dura el "bloqueo"? ¬øante qu√© decisiones? Los par√°metros dan la l√≠nea base.',hint:'Ya tenemos TOPOGRAF√çA. ¬øQu√© falta para cuantificar?'},
{text:'Laura: 4-5 llamadas/d√≠a, bloqueo de 20-40 min, ante cualquier decisi√≥n (qu√© cenar, qu√© ropa, si aceptar un plan). ¬øQu√© tipo de informaci√≥n es esta?',opts:['Etiolog√≠a','Par√°metros: frecuencia, duraci√≥n y contexto','Hip√≥tesis funcional','Diagn√≥stico provisional'],c:1,fb:'Correcto. Frecuencia (4-5/d√≠a), duraci√≥n (20-40 min) y contextos. L√≠nea base medible.',hint:'Estos datos son num√©ricos y cuantificables. ¬øQu√© nombre reciben?'}
]}
]}
]},
2:{title:"Triple Sistema de Respuesta",cheat:["Motor: acciones observables (gritar, evitar, llorar, llamar, quedarse quieto)","Cognitivo: verbalizaciones encubiertas e im√°genes mentales","Fisiol√≥gico: respuestas corporales (taquicardia, sudor, temblor, tensi√≥n)","Las emociones = combinaci√≥n de cognitivo + fisiol√≥gico","Un error com√∫n: confundir respuestas fisiol√≥gicas con motoras"],
theory:[
{icon:'üß©',title:'Los tres componentes',color:'gold',body:`<p class="th">Toda conducta se analiza seg√∫n el <strong>triple sistema de respuesta</strong>: Motor (acciones observables), Cognitivo (pensamientos e im√°genes), Fisiol√≥gico (respuestas corporales).</p>`},
{icon:'üìä',title:'Diagrama del Triple Sistema',color:'teal',body:`<div class="diagram">${DIAGRAMS.triple}<div class="diagram-label">Triple sistema de respuesta</div></div>`},
{icon:'üí°',title:'Las emociones',color:'green',body:`<div class="hl"><em>Las emociones</em> no son un cuarto componente ‚Äî son la <em>combinaci√≥n</em> de cognitivo + fisiol√≥gico. "Sentir ansiedad" = taquicardia + sudor + "me va a dar algo".</div><div class="ex-box"><div class="ex-label">Ejemplo: Fobia a ara√±as</div><p><b>Motor:</b> Salir corriendo, gritar<br><b>Cognitivo:</b> "Me va a picar"<br><b>Fisiol√≥gico:</b> Taquicardia, n√°useas</p></div>`}
],
stages:[
{id:'A',title:'Identifica el componente',sub:'Selecci√≥n',typeLabel:'Componentes',instr:'¬øA qu√© componente del triple sistema pertenece cada descripci√≥n?',exercises:[
{type:'single',text:'"Cada vez que veo a mi jefe, el coraz√≥n se me acelera." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:2,ok:'Aceleraci√≥n card√≠aca = respuesta fisiol√≥gica.',fail:'Taquicardia = fisiol√≥gico.'},
{type:'single',text:'"Me siento y me agarro a la silla." ¬øComponente de sentarse/agarrarse?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:0,ok:'Acciones observables = motor.',fail:'Sentarse y agarrarse son observables = motor.'},
{type:'single',text:'"Me repito: ¬´ma√±ana va a ser un desastre¬ª." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:1,ok:'Verbalizaci√≥n encubierta repetitiva = cognitivo.',fail:'Repetirse una frase internamente = cognitivo.'},
{type:'single',text:'"Nudo en el est√≥mago toda la ma√±ana." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:2,ok:'Sensaci√≥n visceral = fisiol√≥gico.',fail:'Nudo g√°strico = respuesta visceral = fisiol√≥gico.'},
{type:'single',text:'"Me quedo mirando el m√≥vil horas sin hacer nada." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:0,ok:'"Quedarse mirando" es acci√≥n observable = motor.',fail:'Aunque parece inacci√≥n, es conducta observable = motor.'},
{type:'single',text:'"Pienso que nadie me hablar√° en la fiesta." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:1,ok:'Anticipaci√≥n verbal encubierta = cognitivo.',fail:'Anticipaci√≥n de consecuencias = cognitivo.'},
{type:'single',text:'"Me tiemblan las manos al firmar delante de alguien." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:2,ok:'Temblor = respuesta del sistema nervioso = fisiol√≥gico.',fail:'Temblor = fisiol√≥gico.'},
{type:'single',text:'"Llamo enferma al trabajo los lunes." ¬øComponente?',opts:['Motor','Cognitivo','Fisiol√≥gico'],c:0,ok:'Llamar = acci√≥n observable y medible = motor.',fail:'Llamar es acci√≥n manifiesta = motor.'}
]},
{id:'B',title:'Descomp√≥n la descripci√≥n',sub:'Multi-selecci√≥n',typeLabel:'Marca todos',instr:'Selecciona TODOS los componentes presentes en cada descripci√≥n. No a√±adas los que no est√©n descritos.',exercises:[
{type:'multi',text:'"Cuando llego a la fiesta, me sudan las manos, pienso que todos me juzgan y me voy a los 10 minutos." Componentes presentes:',opts:['Motor: irse a los 10 min','Cognitivo: "todos me juzgan"','Fisiol√≥gico: sudoraci√≥n palmar','Motor: no hablar con nadie'],c:[0,1,2],ok:'Motor (irse), cognitivo (juicio) y fisiol√≥gico (sudoraci√≥n). No a√±adas lo no descrito.',fail:'Solo los descritos: irse (M), "me juzgan" (C), sudar (F).'},
{type:'multi',text:'"Despierta en la cama, coraz√≥n acelerado, repasando todo lo que hice mal." Componentes:',opts:['Motor: quedarse despierta','Cognitivo: repasar lo que hizo mal','Fisiol√≥gico: taquicardia','Cognitivo: "soy un desastre"'],c:[0,1,2],ok:'Motor (despierta), cognitivo (repasar), fisiol√≥gico (taquicardia). El cuarto no est√° descrito.',fail:'Los descritos: despierta (M), repasar (C), taquicardia (F).'},
{type:'multi',text:'"Cuando mi pareja llega tarde, grito, se me tensa el cuerpo y pienso ¬´est√° con otra¬ª." Componentes:',opts:['Motor: gritar','Fisiol√≥gico: tensi√≥n corporal','Cognitivo: "est√° con otra"','Motor: comprobar tel√©fono'],c:[0,1,2],ok:'Gritar (M), tensi√≥n (F), pensamiento (C). El cuarto no se menciona.',fail:'Los tres primeros est√°n descritos.'},
{type:'multi',text:'"Antes del examen, dolor de est√≥mago, pienso que voy a suspender y me quedo en blanco." Componentes:',opts:['Fisiol√≥gico: dolor de est√≥mago','Cognitivo: "voy a suspender"','Motor: quedarse en blanco','Fisiol√≥gico: sudoraci√≥n'],c:[0,1,2],ok:'Dolor (F), anticipaci√≥n (C), quedarse en blanco (M). El cuarto no est√°.',fail:'Los presentes: dolor (F), suspender (C), blanco (M).'},
{type:'multi',text:'"Compruebo la puerta, siento alivio moment√°neo, y vuelvo a pensar ¬´¬øy si no cerr√©?¬ª" Componentes:',opts:['Motor: comprobar la puerta','Fisiol√≥gico: alivio (reducci√≥n activaci√≥n)','Cognitivo: "¬øy si no cerr√©?"','Motor: volver a casa'],c:[0,1,2],ok:'Comprobar (M), alivio (F: reducci√≥n activaci√≥n), duda (C).',fail:'Presentes: comprobar (M), alivio (F), duda (C).'},
{type:'multi',text:'"Suena el tel√©fono, taquicardia, pienso que son malas noticias, me quedo paralizada sin contestar." Componentes:',opts:['Fisiol√≥gico: taquicardia','Cognitivo: "malas noticias"','Motor: no contestar / paralizada','Motor: tirar el tel√©fono'],c:[0,1,2],ok:'Taquicardia (F), anticipaci√≥n (C), no contestar (M).',fail:'Presentes: taquicardia (F), malas noticias (C), no contestar (M).'}
]},
{id:'C',title:'Detecta el error',sub:'An√°lisis cr√≠tico',typeLabel:'Encuentra el fallo',instr:'Cada clasificaci√≥n tiene un error. ¬øCu√°l es?',exercises:[
{type:'single',text:'"Tensi√≥n muscular (MOTOR) ante reuniones." ¬øError?',opts:['No hay error','Tensi√≥n muscular es FISIOL√ìGICO, no motor','Deber√≠a decir cognitivo','Falta frecuencia'],c:1,ok:'Tensi√≥n muscular = fisiol√≥gico. Motor ser√≠a una acci√≥n observable.',fail:'Tensi√≥n muscular = fisiol√≥gico, no motor.'},
{type:'single',text:'"Grita a su hijo (FISIOL√ìGICO) cuando desobedece." ¬øError?',opts:['No hay error','Gritar es MOTOR, no fisiol√≥gico','Gritar es cognitivo','Falta contexto'],c:1,ok:'Gritar = acci√≥n observable = motor.',fail:'Gritar = motor.'},
{type:'single',text:'"Siente miedo (COGNITIVO) al ver una ara√±a." ¬øError?',opts:['No hay error','El miedo es EMOCI√ìN = cognitivo + fisiol√≥gico combinados','Miedo es solo fisiol√≥gico','No es conducta'],c:1,ok:'Las emociones combinan cognitivo y fisiol√≥gico. No son solo un componente.',fail:'Emociones = cognitivo + fisiol√≥gico.'},
{type:'single',text:'"Se dice ¬´soy un fracasado¬ª (FISIOL√ìGICO) cada noche." ¬øError?',opts:['No hay error','Es motor','Es COGNITIVO ‚Äî verbalizaci√≥n encubierta','Es emoci√≥n'],c:2,ok:'"Soy un fracasado" = verbalizaci√≥n encubierta = cognitivo.',fail:'Decirse algo = cognitivo.'},
{type:'single',text:'"Evita ir al supermercado (COGNITIVO)." ¬øError?',opts:['No hay error','Evitar es MOTOR; el pensamiento ser√≠a el cognitivo','Evitar es fisiol√≥gico','Es emoci√≥n'],c:1,ok:'Evitar = acci√≥n = motor. "Piensa que le dar√° un ataque" ser√≠a el cognitivo.',fail:'Evitar = acci√≥n = motor.'},
{type:'single',text:'"Llora (FISIOL√ìGICO) durante las sesiones." ¬øError?',opts:['No hay error','Llorar es MOTOR ‚Äî conducta observable','Llorar es cognitivo','No es conducta'],c:1,ok:'Llorar como conducta completa es motor (observable).',fail:'Llorar = observable = motor.'}
]},
{id:'D',title:'Caso: Pablo',sub:'Caso cl√≠nico',typeLabel:'Secuencia',instr:'Analiza el caso paso a paso.',exercises:[
{type:'seq',patient:{name:'Pablo',age:'45 a√±os',gender:'m',initial:'P',badge:'Motivo: "Estr√©s laboral"'},quote:'"No puedo m√°s. Cada ma√±ana antes de ir al trabajo me dan ganas de vomitar, me paso la noche pensando en todo lo que puede salir mal, y he empezado a llegar tarde a prop√≥sito para no coincidir con mi jefe."',questions:[
{text:'¬øCu√°ntos componentes del triple sistema identificas?',opts:['Solo motor','Solo fisiol√≥gico','Los tres: motor, cognitivo y fisiol√≥gico','Solo cognitivo y fisiol√≥gico'],c:2,fb:'Motor: llegar tarde, evitar. Cognitivo: pensar en lo que puede salir mal. Fisiol√≥gico: n√°useas.',hint:'Busca: ¬øqu√© HACE? ¬øqu√© PIENSA? ¬øqu√© SIENTE en el cuerpo?'},
{text:'¬øCu√°l es el componente COGNITIVO?',opts:['N√°useas matutinas','Llegar tarde a prop√≥sito','Pensar por la noche en lo que puede salir mal','Evitar al jefe'],c:2,fb:'Pasar la noche pensando = verbalizaci√≥n encubierta anticipatoria = cognitivo.',hint:'El cognitivo es lo que piensa o se dice a s√≠ mismo.'},
{text:'Pablo a√±ade: "Pienso que me van a despedir y se me cierra el pecho." ¬øComponentes nuevos?',opts:['Solo cognitivo','Solo fisiol√≥gico','Ambos: cognitivo + fisiol√≥gico','Ninguno nuevo'],c:2,fb:'Pensamiento anticipatorio (C) + opresi√≥n tor√°cica (F). Dos componentes nuevos.',hint:'Hay un pensamiento Y una sensaci√≥n corporal nuevos.'},
{text:'¬øQu√© pregunta ser√≠a M√ÅS √∫til ahora?',opts:['"¬øDesde cu√°ndo?"','"¬øQu√© m√°s haces o dejas de hacer?"','"¬øTu jefe quiere despedirte?"','"¬øTomas medicaci√≥n?"'],c:1,fb:'Ya tenemos C y F bien descritos. Falta ampliar el motor: ¬øqu√© otras conductas cambi√≥?',hint:'Ya tienes cognitivo y fisiol√≥gico. ¬øQu√© componente falta ampliar?'}
]}
]}
]},
3:{title:"Par√°metros de la Conducta",cheat:["Ocurrencia: ¬øse da o no? (presencia/ausencia)","Frecuencia: ¬øcu√°ntas veces? (3/d√≠a, 5/semana)","Duraci√≥n: ¬øcu√°nto dura? (20 min, 3 horas)","Intensidad: ¬øcon qu√© magnitud? (audible desde otra habitaci√≥n)","Sin par√°metros no hay l√≠nea base ‚Üí no se puede evaluar cambio"],
theory:[
{icon:'üìè',title:'Medir la conducta',color:'gold',body:`<p class="th">Para que una descripci√≥n sea operacional necesitamos <strong>cuantificar</strong>. La conducta se mide con cuatro par√°metros: <strong>Ocurrencia</strong> (¬øse da?), <strong>Frecuencia</strong> (¬øcu√°ntas veces?), <strong>Duraci√≥n</strong> (¬øcu√°nto tiempo?) e <strong>Intensidad</strong> (¬øcon qu√© magnitud?).</p>`},
{icon:'üìê',title:'Por qu√© importan',color:'teal',body:`<div class="hl"><em>Sin par√°metros no hay l√≠nea base</em>, y sin l√≠nea base no podemos evaluar si la intervenci√≥n funciona. Los par√°metros son la herramienta de medida del terapeuta conductual.</div>`}
],
stages:[
{id:'A',title:'¬øQu√© par√°metro es?',sub:'Identificaci√≥n',typeLabel:'Clasifica',instr:'¬øQu√© par√°metro se est√° midiendo en cada descripci√≥n?',exercises:[
{type:'single',text:'"Se lava las manos 15 veces al d√≠a." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:1,ok:'"15 veces/d√≠a" = frecuencia.',fail:'"15 veces/d√≠a" = frecuencia.'},
{type:'single',text:'"Las crisis de llanto duran 20-40 minutos." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:2,ok:'"20-40 min" = duraci√≥n.',fail:'"20-40 min" = duraci√≥n.'},
{type:'single',text:'"Los gritos son audibles desde el piso de abajo." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:3,ok:'Magnitud = intensidad.',fail:'Magnitud = intensidad.'},
{type:'single',text:'"No presenta conductas de evitaci√≥n." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:0,ok:'Presencia/ausencia = ocurrencia.',fail:'Presencia/ausencia = ocurrencia.'},
{type:'single',text:'"Comprueba la cerradura 5 minutos cada vez." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:2,ok:'"5 min cada vez" = duraci√≥n.',fail:'"5 min cada vez" = duraci√≥n.'},
{type:'single',text:'"Insomnio de inicio 5 noches/semana." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:1,ok:'"5 noches/semana" = frecuencia.',fail:'"5 noches/semana" = frecuencia.'},
{type:'single',text:'"Temblor tan fuerte que no puede sostener un vaso." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:3,ok:'Magnitud funcional = intensidad.',fail:'Magnitud = intensidad.'},
{type:'single',text:'"Rumiaci√≥n 2 horas antes de dormir." ¬øPar√°metro?',opts:['Ocurrencia','Frecuencia','Duraci√≥n','Intensidad'],c:2,ok:'"2 horas" = duraci√≥n.',fail:'"2 horas" = duraci√≥n.'}
]},
{id:'B',title:'¬øQu√© par√°metros hay y faltan?',sub:'Multi-selecci√≥n',typeLabel:'Detecta',instr:'Selecciona los par√°metros PRESENTES y los que FALTAN.',exercises:[
{type:'multi',text:'"Mi hijo pega en el recreo 3 veces/semana, 2 min cada episodio, golpes que dejan marcas." ¬øPresentes?',opts:['Frecuencia (3/semana)','Duraci√≥n (2 min)','Intensidad (dejan marcas)','Ocurrencia'],c:[0,1,2],ok:'Frecuencia, duraci√≥n e intensidad presentes.',fail:'Frecuencia (3/semana), duraci√≥n (2 min), intensidad (marcas).'},
{type:'multi',text:'"Se autolesiona cort√°ndose 2 veces al mes." ¬øQu√© hay y qu√© FALTA?',opts:['Presente: Frecuencia','Presente: Ocurrencia','Falta: Duraci√≥n del episodio','Falta: Intensidad'],c:[0,1,2,3],ok:'Frecuencia y ocurrencia presentes. Falta duraci√≥n e intensidad ‚Äî cr√≠tico para evaluar riesgo.',fail:'Frecuencia y ocurrencia presentes, falta duraci√≥n e intensidad.'},
{type:'multi',text:'"Desde hace 3 meses no sale de casa." ¬øPresentes?',opts:['Ocurrencia (s√≠ se da)','Duraci√≥n (3 meses)','Frecuencia (todos los d√≠as)','Intensidad (total)'],c:[0,1,2,3],ok:'Todos inferibles: ocurre, 3 meses, constante, total.',fail:'Todos los par√°metros son inferibles aqu√≠.'},
{type:'multi',text:'"A veces Ana llora." ¬øPresentes?',opts:['Ocurrencia (s√≠)','Frecuencia espec√≠fica','Duraci√≥n espec√≠fica','Intensidad espec√≠fica'],c:[0],ok:'Solo ocurrencia. "A veces" no es par√°metro cuantificado.',fail:'Solo ocurrencia. "A veces" es vago.'}
]},
{id:'C',title:'Mejor forma de medir',sub:'Evaluaci√≥n',typeLabel:'Decide',instr:'¬øCu√°l es la mejor estrategia de medici√≥n para cada caso?',exercises:[
{type:'single',text:'"Ataques de ira". ¬øMejor forma de medir?',opts:['Cuestionario de ira','Registrar frecuencia, duraci√≥n e indicadores de intensidad','Preguntar si es leve/moderada/severa','Pedir a familiares que califiquen 1-10'],c:1,ok:'Registro directo de par√°metros = base de evaluaci√≥n conductual.',fail:'El registro directo de par√°metros es la mejor base.'},
{type:'single',text:'¬øMejor indicador de INTENSIDAD para "crisis de ansiedad"?',opts:['Escala 1-10','Tasa card√≠aca','Indicadores observables: temblor, llanto, necesidad de irse','Inventario estandarizado'],c:2,ok:'Indicadores observables son m√°s fiables que escalas subjetivas.',fail:'Indicadores observables son m√°s medibles y objetivos.'},
{type:'single',text:'Paciente dice "siempre" est√° triste. ¬øMejor pregunta?',opts:['"¬øDesde cu√°ndo?"','"¬øCu√°ntas horas/d√≠a el llanto o inactividad est√°n presentes?"','"¬øEs tristeza normal o patol√≥gica?"','"¬øTe impide funcionar?"'],c:1,ok:'Convierte "siempre triste" en horas/d√≠a de conductas concretas.',fail:'Horas/d√≠a de conductas concretas = datos cuantificables.'},
{type:'single',text:'Medir si la intervenci√≥n reduce comprobaci√≥n. ¬øPar√°metro prioritario?',opts:['Intensidad de ansiedad','Frecuencia diaria de comprobaciones','Duraci√≥n del tratamiento','Si se siente mejor'],c:1,ok:'Frecuencia diaria = dato m√°s directo y comparable.',fail:'Frecuencia diaria = comparaci√≥n objetiva l√≠nea base vs. tratamiento.'},
{type:'single',text:'¬øPor qu√© NO basta medir solo frecuencia de "atracones"?',opts:['Frecuencia no es v√°lida','Tambi√©n necesitamos duraci√≥n e intensidad (cantidad ingerida)','Lo importante es el diagn√≥stico','Puede mentir'],c:1,ok:'Un atrac√≥n de 10 min ‚â† uno de 2 horas. Necesitamos todos los par√°metros.',fail:'Frecuencia sola no captura gravedad. Duraci√≥n + intensidad completan.'}
]},
{id:'D',title:'Caso: Marcos',sub:'Caso cl√≠nico',typeLabel:'Secuencia',instr:'Analiza los par√°metros del caso.',exercises:[
{type:'seq',patient:{name:'Marcos',age:'28 a√±os',gender:'m',initial:'M',badge:'Motivo: "Insomnio"'},quote:'"No duermo nada. Llevo as√≠ meses. Es insoportable."',questions:[
{text:'¬øContiene par√°metros cuantificados?',opts:['S√≠ ‚Äî "meses" y "nada" son par√°metros','No ‚Äî son expresiones vagas'],c:1,fb:'"Nada" y "meses" son vagos. ¬øCu√°ntas horas? ¬øCu√°ntos meses? ¬øTodas las noches?',hint:'¬ø"Nada" es cero horas literalmente? ¬ø"Meses" son 2 o 12?'},
{text:'Tras preguntar: "Tardo 90 min en dormirme, despierto 2-3 veces, duermo 4-5h." ¬øPar√°metros?',opts:['Solo frecuencia','Duraci√≥n de latencia + frecuencia despertares','Duraci√≥n latencia + frecuencia despertares + duraci√≥n total sue√±o','Solo intensidad'],c:2,fb:'Latencia 90min (duraci√≥n), despertares 2-3/noche (frecuencia), sue√±o 4-5h (duraci√≥n). L√≠nea base medible.',hint:'Hay tres datos num√©ricos diferentes.'},
{text:'¬øQu√© par√°metro FALTA?',opts:['La causa','Intensidad: impacto en funcionamiento diurno','Diagn√≥stico','Medicaci√≥n'],c:1,fb:'Falta intensidad: ¬øimpide trabajar? ¬øse duerme conduciendo? Esto mide la magnitud del impacto.',hint:'Sabemos cu√°nto y cu√°ndo. ¬øPero qu√© TAN grave es el impacto?'}
]}
]}
]},
4:{title:"Operacionalizaci√≥n Completa",cheat:["Operacionalizar = etiqueta ‚Üí conducta concreta, observable, medible, contextualizada","Una buena operacionalizaci√≥n incluye: topograf√≠a + par√°metros + contexto","Regla de oro: si dos observadores no se ponen de acuerdo, no est√° operacionalizado","El esquema E‚ÜíR‚ÜíE estructura la operacionalizaci√≥n completa","La calidad se mide: ¬øpuedo observar, contar, medir lo descrito?"],
theory:[
{icon:'üéØ',title:'El arte de operacionalizar',color:'gold',body:`<p class="th"><strong>Operacionalizar</strong> = transformar etiquetas en conductas concretas, observables, medibles y contextualizadas dentro del esquema E‚ÜíR‚ÜíE.</p><p class="th">Una buena operacionalizaci√≥n: 1) Topograf√≠a (triple sistema), 2) Par√°metros, 3) Contexto estimular.</p>`},
{icon:'üìê',title:'Esquema E‚ÜíR‚ÜíE',color:'teal',body:`<div class="diagram">${DIAGRAMS.ere}<div class="diagram-label">Secuencia funcional: Antecedente ‚Üí Respuesta ‚Üí Consecuente</div></div>`},
{icon:'‚úÖ',title:'Regla de oro',color:'green',body:`<div class="hl"><em>Regla de oro:</em> Si dos observadores independientes no podr√≠an ponerse de acuerdo en si la conducta ocurri√≥, la descripci√≥n NO est√° operacionalizada.</div>`}
],
stages:[
{id:'A',title:'Detecta el error',sub:'An√°lisis cr√≠tico',typeLabel:'Errores',instr:'¬øQu√© falla en cada operacionalizaci√≥n?',exercises:[
{type:'single',text:'"Conductas agresivas frecuentes." ¬øQu√© falla?',opts:['Est√° bien','Falta topograf√≠a concreta y "frecuentes" no es cuantificable','Solo falta contexto','Solo falta intensidad'],c:1,ok:'"Agresivas" es vago y "frecuentes" no es medible.',fail:'Falta topograf√≠a y cuantificaci√≥n.'},
{type:'single',text:'"Se lava manos 20 veces/d√≠a, 3 minutos." ¬øQu√© falta?',opts:['Nada','Contexto: ¬øcu√°ndo, ante qu√© est√≠mulos?','Intensidad','Cognitivo'],c:1,ok:'Topograf√≠a y par√°metros OK, pero falta contexto estimular.',fail:'Falta contexto: ¬ødespu√©s de qu√©? ¬ød√≥nde? ¬øante qu√©?'},
{type:'single',text:'"Problemas de conducta en el colegio." ¬øCu√°ntos errores?',opts:['Uno','Dos','Al menos tres: topograf√≠a + par√°metros + contexto espec√≠fico','Ninguno'],c:2,ok:'"Problemas de conducta" (vago) + sin par√°metros + contexto insuficiente.',fail:'Tres errores: topograf√≠a vaga, sin par√°metros, contexto insuficiente.'},
{type:'single',text:'"Pedro grita a compa√±eros cuando le interrumpen, 2-3 veces/semana, audible desde sala contigua, 30 segundos." ¬øCalidad?',opts:['Mala','Regular','Buena: topograf√≠a + par√°metros + contexto','Excesiva'],c:2,ok:'Conducta + contexto + frecuencia + duraci√≥n + intensidad. Excelente.',fail:'Tiene todo: topograf√≠a, contexto, frecuencia, duraci√≥n, intensidad.'},
{type:'single',text:'"Sintomatolog√≠a ansiosa con componentes som√°ticos y cognitivos." ¬øCalidad?',opts:['Buena','Mala ‚Äî lenguaje t√©cnico que no operacionaliza nada','Regular','Excelente'],c:1,ok:'Suena profesional pero no dice NADA concreto. Lenguaje vac√≠o.',fail:'No operacionaliza nada: ¬øqu√© som√°ticos? ¬øqu√© cognitivos? ¬øcu√°ndo?'},
{type:'single',text:'"Al ver un perro, cruza de acera, dice ¬´me va a morder¬ª, tiemblan las piernas, 4-5 veces/semana." ¬øCalidad?',opts:['Mala','Excelente: triple sistema + par√°metros + contexto','Regular','Solo falta duraci√≥n'],c:1,ok:'Triple sistema + frecuencia + contexto. Excelente operacionalizaci√≥n.',fail:'Tiene todo: motor + cognitivo + fisiol√≥gico + frecuencia + contexto.'}
]},
{id:'B',title:'Ordena la calidad',sub:'Ordenamiento',typeLabel:'Ordena',instr:'Ordena de PEOR a MEJOR operacionalizaci√≥n. Toca en orden. Puedes deshacer con el bot√≥n.',exercises:[
{type:'order',items:['Es agresivo','Conductas agresivas frecuentes','Golpea a compa√±eros 3 veces/semana','Golpea pu√±etazos en recreo, 3/semana, cuando le quitan el bal√≥n, dejando marcas'],ok:'De etiqueta pura ‚Üí operacionalizaci√≥n completa.',fail:'Orden correcto: etiqueta ‚Üí etiqueta+adj ‚Üí conducta+1 par√°metro ‚Üí completa.'},
{type:'order',items:['Tiene ansiedad','Ansiedad moderada con s√≠ntomas som√°ticos','Suda y tiembla al hablar en p√∫blico','Antes de presentaciones (2/mes), sudoraci√≥n, temblor y "me va a dar algo", 5 min previos'],ok:'De etiqueta ‚Üí descripci√≥n vac√≠a ‚Üí parcial ‚Üí completa.',fail:'De peor a mejor: etiqueta ‚Üí jerga ‚Üí parcial ‚Üí completa.'},
{type:'order',items:['Est√° deprimida','√Ånimo depresivo persistente','Llora todos los d√≠as y no sale de casa','En cama hasta las 15h (5/semana), llora 2-3/d√≠a (10-15 min), 0 salidas/mes vs 8 previas, dice "no merece la pena"'],ok:'La √∫ltima incluye conductas + par√°metros + l√≠nea base comparativa.',fail:'De etiqueta ‚Üí jerga ‚Üí conductas sin par√°metros ‚Üí completa con l√≠nea base.'}
]},
{id:'C',title:'Construye paso a paso',sub:'Producci√≥n guiada',typeLabel:'Construye',instr:'Gu√≠a al terapeuta paso a paso para construir la operacionalizaci√≥n.',exercises:[
{type:'seq',patient:{name:'Paciente',age:'‚Äî',gender:'m',initial:'?',badge:'Queja: "Tengo ansiedad"'},quote:'"Tengo mucha ansiedad."',questions:[
{text:'PASO 1 ‚Äî ¬øPrimera pregunta?',opts:['"¬øDesde cu√°ndo?"','"¬øQu√© haces exactamente cuando dices que tienes ansiedad?"','"¬øHas ido al m√©dico?"','"¬øEs normal o patol√≥gica?"'],c:1,fb:'Buscar TOPOGRAF√çA: ¬øqu√© hace, piensa, siente? Convierte etiqueta en conductas.',hint:'Primer paso siempre: ¬øQU√â hace concretamente?'},
{text:'Responde: "Me cuesta respirar, pienso que me voy a morir, me quedo paralizado." PASO 2:',opts:['"¬øCon qu√© frecuencia? ¬øCu√°nto dura?"','"¬øQu√© lo causa?"','"¬øAntecedentes familiares?"','"¬øHas probado relajaci√≥n?"'],c:0,fb:'Topograf√≠a OK. Ahora PAR√ÅMETROS: ¬øcu√°ntas veces? ¬øcu√°nto dura?',hint:'Ya tienes QU√â. Ahora necesitas CU√ÅNTO.'},
{text:'"3-4 veces/semana, 10-15 min." PASO 3:',opts:['"¬øQu√© situaciones lo provocan? ¬øD√≥nde? ¬øQu√© pasa antes?"','"¬øQu√© edad cuando empez√≥?"','"¬øAfecta al trabajo?"','"¬øQu√© haces para calmarte?"'],c:0,fb:'Necesitamos CONTEXTO: antecedentes E‚Üí. ¬øAnte qu√© est√≠mulos?',hint:'Ya tienes QU√â y CU√ÅNTO. Necesitas CU√ÅNDO y D√ìNDE.'},
{text:'"Siempre en el trabajo, cuando el jefe pide algo urgente." PASO 4: ¬øQu√© falta?',opts:['Nada','Las CONSECUENCIAS: ¬øqu√© ocurre despu√©s?','El diagn√≥stico','Historia de aprendizaje'],c:1,fb:'Falta ‚ÜíE: ¬øqu√© pasa despu√©s? ¬øse va? ¬øalguien ayuda? ¬øjefe deja de pedir? Las consecuencias determinan la funci√≥n.',hint:'Tienes E‚ÜíR. ¬øQu√© falta del esquema E‚ÜíR‚ÜíE?'}
]},
{type:'seq',patient:{name:'Madre',age:'‚Äî',gender:'f',initial:'M',badge:'Queja: "Mi hijo es rebelde"'},quote:'"Mi hijo de 8 a√±os es muy rebelde. No hace caso nunca."',questions:[
{text:'PASO 1 ‚Äî ¬øMejor primera pregunta?',opts:['"¬øQu√© hace exactamente que usted llama rebeld√≠a?"','"¬øC√≥mo es la relaci√≥n con el padre?"','"¬øHa consultado al pediatra?"','"¬øSiempre ha sido as√≠?"'],c:0,fb:'"Rebeld√≠a" es etiqueta. Necesitamos topograf√≠a: ¬øqu√© conductas concretas?',hint:'Convierte la etiqueta en conductas observables.'},
{text:'"Grita, tira cosas y me dice ¬´eres tonta¬ª." ¬øSiguiente?',opts:['"¬øCon qu√© frecuencia? ¬øCu√°nto duran?"','"¬øLo castiga?"','"¬øQu√© notas saca?"','"¬øNecesita medicaci√≥n?"'],c:0,fb:'Topograf√≠a OK. Ahora par√°metros: frecuencia, duraci√≥n.',hint:'Ya tienes QU√â hace. Ahora: ¬øCU√ÅNTO?'}
]}
]},
{id:'D',title:'Caso completo: Sof√≠a',sub:'Integraci√≥n',typeLabel:'Caso completo',instr:'Aplica todos los pasos a un caso real.',exercises:[
{type:'seq',patient:{name:'Sof√≠a',age:'25 a√±os',gender:'f',initial:'S',badge:'Motivo: "Coraz√≥n roto"'},quote:'"Tengo el coraz√≥n roto. No puedo seguir as√≠. Estoy destruida por dentro."',questions:[
{text:'Sof√≠a usa met√°foras. ¬øPrimer paso?',opts:['Explorar la relaci√≥n','"¬øQu√© haces, piensas o sientes concretamente?"','Validar antes de preguntar','Cuestionario de depresi√≥n'],c:1,fb:'Operacionalizar: ¬øqu√© conductas hay detr√°s de "coraz√≥n roto"?',hint:'Antes de asumir nada, convierte las met√°foras en conductas.'},
{text:'Sof√≠a: "No paro de llorar, no puedo comer, no duermo, todo el rato pienso en √©l." ¬øTriple sistema?',opts:['Solo motor','Solo fisiol√≥gico','Motor (llorar, no comer) + fisiol√≥gico (insomnio) + cognitivo (rumiaci√≥n)','Solo cognitivo'],c:2,fb:'Motor: llorar, no comer. Fisiol√≥gico: insomnio. Cognitivo: pensar en √©l.',hint:'Busca los tres componentes en lo que dice.'},
{text:'¬øSiguiente pregunta?',opts:['"¬øCu√°ntas veces/d√≠a lloras? ¬øHoras pensando en √©l? ¬øD√≠as sin dormir bien?"','"¬øCu√°ndo termin√≥?"','"¬øPodr√≠as volver con √©l?"','"¬øPensamientos de hacerte da√±o?"'],c:0,fb:'Par√°metros: frecuencia llanto, duraci√≥n rumiaci√≥n, cuantificaci√≥n insomnio y restricci√≥n alimentaria.',hint:'Ya tienes topograf√≠a. Necesitas CUANTIFICAR.'},
{text:'4-5 llantos/d√≠a (15-20 min), 6h/d√≠a pensando en √©l, no cena hace 2 semanas, 3-4h sue√±o/noche. ¬øQu√© falta?',opts:['Diagn√≥stico','Contexto antecedente + consecuencias','Historia de relaciones','Medicaci√≥n'],c:1,fb:'Falta E‚Üí (¬øqu√© lo dispara? ¬øver redes? ¬øestar sola?) y ‚ÜíE (¬øqu√© pasa despu√©s?). Esto completar√≠a E‚ÜíR‚ÜíE.',hint:'Tienes R con par√°metros. Falta el contexto: ¬øla E de cada lado?'}
]}
]}
]},
5:{title:"Funci√≥n vs. Morfolog√≠a",cheat:["La conducta se define por su FUNCI√ìN, no por su forma","Misma topograf√≠a puede tener funciones distintas (llorar por atenci√≥n vs. por escape)","Diferente topograf√≠a puede cumplir la misma funci√≥n (equivalencia funcional)","R+: se a√±ade algo ‚Üí conducta aumenta. R-: se quita algo aversivo ‚Üí conducta aumenta","C+: se a√±ade algo aversivo ‚Üí baja. C-: se quita algo deseado ‚Üí baja","Si eliminamos una conducta sin abordar la funci√≥n, aparecer√° otra"],
theory:[
{icon:'üîÑ',title:'Funci√≥n ‚â† Forma',color:'gold',body:`<p class="th">Dos conductas pueden verse igual pero tener funciones distintas. Y conductas muy diferentes pueden cumplir la misma funci√≥n.</p><div class="hl"><em>La operante se define por su funci√≥n</em> ‚Äî por los efectos que produce ‚Äî no por su morfolog√≠a.</div>`},
{icon:'üìä',title:'Esquema E‚ÜíR‚ÜíE',color:'teal',body:`<div class="diagram">${DIAGRAMS.ere}<div class="diagram-label">La funci√≥n se determina por las CONSECUENCIAS</div></div>`},
{icon:'üí°',title:'Ejemplos clave',color:'green',body:`<div class="ex-box"><div class="ex-label">Misma topograf√≠a ‚â† funci√≥n</div><p>Ni√±o llora: A) Madre se va ‚Üí madre vuelve = <b>R+</b> | B) Le dan verdura ‚Üí retiran plato = <b>R-</b></p></div><div class="ex-box"><div class="ex-label">‚â† topograf√≠a = misma funci√≥n</div><p>Adolescente ante deberes: dice "me duele la cabeza" / tira libros / llora ‚Üí todos = <b>R- (escape)</b></p></div>`}
],
stages:[
{id:'A',title:'Misma topograf√≠a ‚â† funci√≥n',sub:'An√°lisis',typeLabel:'Compara',instr:'Analiza por qu√© la misma conducta tiene diferente funci√≥n seg√∫n el contexto.',exercises:[
{type:'single',text:'Mar√≠a grita: (A) Al hijo que no recoge ‚Üí hijo recoge. (B) A pareja en discusi√≥n ‚Üí pareja se calla. ¬øFunciones?',opts:['Ambos igual','(A) R+ (obtiene obediencia) y (B) R- (elimina discusi√≥n)','Mar√≠a es agresiva','Ambos R+'],c:1,ok:'(A) produce obediencia = R+. (B) elimina discusi√≥n = R-. Misma topograf√≠a, distinta funci√≥n.',fail:'(A) obtiene algo = R+. (B) elimina algo aversivo = R-.'},
{type:'single',text:'Autolesi√≥n: (A) Siente "vac√≠o", se corta, siente "algo". (B) Discute con pareja, se corta, pareja deja de enfadarse. ¬øFunciones?',opts:['Ambas R+','(A) R+ (produce estimulaci√≥n) y (B) R- (elimina enfado)','Ambas R-','Siempre igual'],c:1,ok:'(A) produce estimulaci√≥n = R+. (B) elimina enfado = R-. Intervenci√≥n distinta para cada caso.',fail:'(A) produce sensaci√≥n = R+. (B) elimina enfado = R-.'},
{type:'single',text:'Ni√±o dice "me duele la tripa": (A) Antes del colegio ‚Üí queda en casa. (B) Tras comer mucho ‚Üí madre da medicina. ¬øFunciones?',opts:['Ambas iguales','(A) posible R- (escape colegio) y (B) posible R+ (obtiene cuidados)','Tiene dolor real','No analizable'],c:1,ok:'(A) escape de colegio = R-. (B) obtiene cuidados = R+. Misma frase, distinta funci√≥n.',fail:'(A) escape = R-. (B) obtiene atenci√≥n = R+.'},
{type:'single',text:'Adulto llora: (A) Solo en su habitaci√≥n ‚Üí se siente aliviado. (B) Con terapeuta ‚Üí terapeuta le dedica m√°s tiempo. ¬øFunciones?',opts:['Ambas expresi√≥n emocional','(A) regulaci√≥n (R-: reduce malestar) y (B) R+ (obtiene atenci√≥n/tiempo)','Siempre R-','No analizable'],c:1,ok:'(A) reduce malestar = R-. (B) produce m√°s tiempo = R+.',fail:'(A) R-. (B) R+. Misma conducta, diferente funci√≥n.'}
]},
{id:'B',title:'Identifica la funci√≥n',sub:'An√°lisis funcional',typeLabel:'R+ R- C+ C-',instr:'Determina qu√© tipo de contingencia mantiene la conducta.',exercises:[
{type:'single',text:'Evita reuniones sociales ‚Üí ansiedad baja. ¬øFunci√≥n?',opts:['R+','R-','C+','Extinci√≥n'],c:1,ok:'Elimina ansiedad = R-. Mantiene la evitaci√≥n.',fail:'Evitar elimina algo aversivo = R-.'},
{type:'single',text:'Ni√±o hace berrinche ‚Üí madre compra lo que pide. ¬øFunci√≥n?',opts:['R+: obtiene lo que quiere','R-','C+','Extinci√≥n'],c:0,ok:'Produce algo deseado = R+.',fail:'Se a√±ade algo deseado = R+.'},
{type:'single',text:'Estudia para evitar bronca de padres. ¬øFunci√≥n del estudio?',opts:['R+','R-: evita la bronca','C+','Sin funci√≥n operante'],c:1,ok:'Previene est√≠mulo aversivo = R-.',fail:'Evita la bronca = R-.'},
{type:'single',text:'Publica selfies ‚Üí recibe likes ‚Üí publica m√°s. ¬øFunci√≥n?',opts:['R+','R-','C-','Extinci√≥n'],c:0,ok:'Se a√±ade algo positivo (likes) ‚Üí conducta aumenta = R+.',fail:'Likes = estimulaci√≥n positiva a√±adida = R+.'},
{type:'single',text:'Ni√±o toca plancha ‚Üí quemadura ‚Üí no vuelve a tocar. ¬øFunci√≥n?',opts:['R+','R-','C+: se a√±ade aversivo ‚Üí baja conducta','C-'],c:2,ok:'Se a√±ade est√≠mulo aversivo ‚Üí conducta disminuye = C+.',fail:'Dolor a√±adido ‚Üí conducta baja = C+.'},
{type:'single',text:'Le quitan el m√≥vil por llegar tarde ‚Üí llega tarde menos. ¬øFunci√≥n?',opts:['R+','R-','C+','C-: se retira positivo ‚Üí baja conducta'],c:3,ok:'Se retira algo deseado ‚Üí conducta baja = C-.',fail:'Se retira el m√≥vil (deseado) ‚Üí conducta baja = C-.'}
]},
{id:'C',title:'Equivalencia funcional',sub:'Multi-selecci√≥n',typeLabel:'Misma funci√≥n',instr:'¬øQu√© conductas diferentes podr√≠an cumplir la MISMA funci√≥n?',exercises:[
{type:'multi',text:'Adolescente quiere ESCAPAR de los deberes (R-). ¬øCu√°les?',opts:['"Me duele la cabeza"','Pelea con hermano','Llorar hasta que mam√° los hace','Sentarse a hacerlos','Tirar los libros'],c:[0,1,2,4],ok:'Todas excepto hacerlos = escape (R-). Diferentes topograf√≠as, misma funci√≥n.',fail:'Todas excepto hacerlos son escape.'},
{type:'multi',text:'Paciente busca ATENCI√ìN de pareja (R+). ¬øCu√°les?',opts:['Hablar de tema interesante','Quejarse de dolor','Discutir','Cocinar algo especial','Amenazar con autolesionarse'],c:[0,1,2,3,4],ok:'TODAS pueden obtener atenci√≥n. Desde conductas "positivas" hasta "negativas".',fail:'Todas obtienen atenci√≥n: misma funci√≥n, topograf√≠as muy distintas.'},
{type:'single',text:'¬øPor qu√© es IMPORTANTE identificar equivalencia funcional?',opts:['Facilita el diagn√≥stico','Si eliminamos UNA topograf√≠a sin abordar la funci√≥n, aparecer√° otra','Todas las problem√°ticas tienen misma funci√≥n','Misma t√©cnica para todas'],c:1,ok:'Si la funci√≥n no se aborda, la persona encontrar√° otra conducta que la cumpla.',fail:'Sin abordar la funci√≥n, eliminar una conducta solo produce sustituci√≥n.'}
]},
{id:'D',title:'Caso: Daniel',sub:'Caso completo',typeLabel:'Caso',instr:'An√°lisis funcional completo de un caso infantil.',exercises:[
{type:'seq',patient:{name:'Daniel',age:'10 a√±os',gender:'c',initial:'D',badge:'Derivado: "Se porta mal"'},quote:'Profesora: "Interrumpe, se levanta del pupitre, a veces tira material al suelo."',questions:[
{text:'La profesora dice "es un ni√±o dif√≠cil". ¬øQu√© le dir√≠as?',opts:['"Probablemente TDAH"','"Necesitamos operacionalizar: ¬øqu√©, cu√°ndo, con qu√© frecuencia, qu√© pasa despu√©s?"','"Es normal"','"M√°s disciplina"'],c:1,fb:'Operacionalizar: topograf√≠a + par√°metros + antecedentes + consecuencias.',hint:'Las etiquetas no gu√≠an la intervenci√≥n.'},
{text:'Daniel interrumpe 12 veces/clase de mates, 8 veces se levanta. NO lo hace en educaci√≥n f√≠sica ni arte. ¬øQu√© indica?',opts:['Problema selectivo','CONTROL ESTIMULAR: ocurre ante est√≠mulos espec√≠ficos','Finge','Profesor malo'],c:1,fb:'La conducta solo ocurre en un contexto = control estimular. No es "rasgo" del ni√±o.',hint:'Si fuera rasgo, ocurrir√≠a en todas las clases.'},
{text:'Cuando interrumpe, la profesora dice "¬°Daniel, si√©ntate!" Todos le miran. Daniel sonr√≠e. ¬øFunci√≥n?',opts:['R- (escapa de mates)','R+ (obtiene atenci√≥n de profesora y compa√±eros)','C+ (recibe rega√±o)','Impulsividad'],c:1,fb:'Reprimenda p√∫blica + miradas + sonrisa = R+. La "disciplina" est√° reforzando la conducta.',hint:'La sonrisa de Daniel es la pista clave.'},
{text:'Si funci√≥n = R+ (atenci√≥n), ¬øintervenci√≥n?',opts:['Castigar m√°s','Extinguir atenci√≥n ante disrupci√≥n + reforzar diferencialmente participaci√≥n adecuada','Medicar','Cambiar de clase'],c:1,fb:'Extinci√≥n de R+ + reforzamiento diferencial. La intervenci√≥n se deriva del an√°lisis funcional.',hint:'¬øC√≥mo eliminas el R+ y lo rediriges a conducta adecuada?'}
]}
]}
]},
6:{title:"Caso Cl√≠nico Integrador",cheat:["Secuencia completa: queja ‚Üí operacionalizar ‚Üí cuantificar ‚Üí contextualizar ‚Üí consecuencias ‚Üí hip√≥tesis funcional","Cada caso es √∫nico: misma etiqueta ‚â† misma funci√≥n","El an√°lisis funcional gu√≠a la intervenci√≥n","La conducta se explica por funci√≥n + par√°metros + contingencias","Dos personas con 'depresi√≥n' pueden tener contingencias completamente distintas"],
theory:[
{icon:'üèÜ',title:'Integraci√≥n final',color:'gold',body:`<p class="th">El proceso completo: 1) Recibir queja ‚Üí 2) Operacionalizar (triple sistema) ‚Üí 3) Cuantificar (par√°metros) ‚Üí 4) Contextualizar (E‚Üí) ‚Üí 5) Consecuencias (‚ÜíE) ‚Üí 6) Hip√≥tesis funcional.</p>`},
{icon:'üîó',title:'Esquema completo',color:'teal',body:`<div class="diagram">${DIAGRAMS.ere}<div class="diagram-label">El an√°lisis funcional completo gu√≠a la intervenci√≥n</div></div>`}
],
stages:[
{id:'A',title:'Elena: "Ansiedad laboral"',sub:'Caso adulto',typeLabel:'Caso completo',instr:'An√°lisis E‚ÜíR‚ÜíE completo.',exercises:[
{type:'seq',patient:{name:'Elena',age:'28 a√±os',gender:'f',initial:'E',badge:'Dise√±adora gr√°fica'},quote:'"Tengo una ansiedad horrible en el trabajo. Creo que necesito medicaci√≥n."',questions:[
{text:'Elena: "Al presentar dise√±os al equipo, tiemblo, me sudan manos, hablo r√°pido y pienso que notar√°n que no estoy preparada." ¬øTriple sistema?',opts:['Motor: temblar. Cognitivo: hablar r√°pido. Fisiol√≥gico: sudor.','Motor: hablar r√°pido. Cognitivo: "van a notar...". Fisiol√≥gico: temblor+sudor.','Todo fisiol√≥gico','Solo motor y fisiol√≥gico'],c:1,fb:'Motor: hablar r√°pido. Cognitivo: anticipaci√≥n negativa. Fisiol√≥gico: temblor+sudor.',hint:'Hablar r√°pido es observable = motor. La frase que piensa = cognitivo.'},
{text:'Presentaciones 2/semana. Temblor 30 min antes, dura 20 min. Ha faltado "enferma" 3 veces en 2 meses. ¬øPar√°metros?',opts:['Solo frecuencia','Frecuencia (2/sem + 3 ausencias), duraci√≥n (30+20 min), intensidad (causa evitaci√≥n)','Solo duraci√≥n','No cuantificados'],c:1,fb:'Frecuencia de exposici√≥n y evitaci√≥n, duraci√≥n, e intensidad inferida (causa evitaci√≥n).',hint:'Cuenta los n√∫meros que aparecen en la descripci√≥n.'},
{text:'¬øCu√°l es el est√≠mulo antecedente?',opts:['El trabajo en general','Presentar dise√±os ante el equipo (evaluaci√≥n social)','El jefe','Su personalidad'],c:1,fb:'Antecedente espec√≠fico: evaluaci√≥n social al presentar. No "el trabajo" en general.',hint:'Elena no tiene s√≠ntomas dise√±ando sola.'},
{text:'Cuando llama enferma, ¬øfunci√≥n de la evitaci√≥n?',opts:['R+: d√≠a libre','R-: elimina ansiedad y exposici√≥n','C+: culpa','Extinci√≥n'],c:1,fb:'Evitar elimina ansiedad + exposici√≥n = R-. Mantiene el problema (no hay habituaci√≥n).',hint:'¬øQu√© se ELIMINA cuando no va?'}
]}
]},
{id:'B',title:'Miguel: "Es agresivo"',sub:'Caso infantil',typeLabel:'Caso completo',instr:'An√°lisis funcional de un caso infantil.',exercises:[
{type:'seq',patient:{name:'Miguel',age:'6 a√±os',gender:'c',initial:'M',badge:'Los padres consultan'},quote:'"Nuestro hijo es muy agresivo. Pega a otros ni√±os."',questions:[
{text:'¬ø"Pega a otros ni√±os" est√° operacionalizado?',opts:['S√≠','No ‚Äî falta: ¬øa qui√©n? ¬øfrecuencia? ¬øcontextos? ¬øantes/despu√©s?','Solo falta diagn√≥stico','S√≠, para empezar a intervenir'],c:1,fb:'Insuficiente. Necesitamos topograf√≠a detallada, par√°metros, antecedentes y consecuentes.',hint:'¬øPodr√≠an dos observadores estar de acuerdo en CU√ÅNDO y POR QU√â pega?'},
{text:'"En el parque, cuando le quitan un juguete, da pu√±etazos y patadas, 3-4 veces/semana." ¬øAntecedente?',opts:['Ir al parque','Que le quiten un juguete (p√©rdida de reforzador)','Padres sin l√≠mites','Mucha energ√≠a'],c:1,fb:'P√©rdida de reforzador = est√≠mulo aversivo que dispara la agresi√≥n.',hint:'¬øQu√© ocurre JUSTO ANTES de que pegue?'},
{text:'Cuando pega, el otro ni√±o le devuelve el juguete. ¬øFunci√≥n?',opts:['R+ (obtiene lo que quiere)','R- (escapa de algo)','C+ (le pegan de vuelta)','Sin funci√≥n'],c:0,fb:'Pegar ‚Üí devuelven juguete = R+. La agresi√≥n produce lo deseado.',hint:'¬øQu√© OBTIENE tras pegar?'},
{text:'E·¥Ö (quitan juguete) ‚Üí R (golpes, 3-4/sem) ‚Üí E (devuelven juguete = R+). ¬øIntervenci√≥n?',opts:['Castigo f√≠sico','Ense√±ar alternativas (pedir, turnos) + que la agresi√≥n no produzca resultado','Retirar del parque','Medicar'],c:1,fb:'Extinguir R+ de agresi√≥n + reforzar alternativas funcionales. Del an√°lisis funcional a la intervenci√≥n.',hint:'¬øC√≥mo cambias las contingencias?'}
]}
]},
{id:'C',title:'Carmen: "Atracones"',sub:'Conducta compleja',typeLabel:'Caso completo',instr:'An√°lisis de una conducta compleja con m√∫ltiples funciones.',exercises:[
{type:'seq',patient:{name:'Carmen',age:'35 a√±os',gender:'f',initial:'C',badge:'Motivo: "No puedo parar"'},quote:'"No puedo parar de comer. Tengo atracones horribles. Soy adicta a la comida."',questions:[
{text:'¬øQu√© operacionalizar primero?',opts:['Qu√© come, cu√°nto, duraci√≥n, frecuencia','Criterios TCA','Si ha hecho dietas','Relaci√≥n infantil con comida'],c:0,fb:'"Atrac√≥n" debe operacionalizarse: alimentos, cantidad, duraci√≥n, frecuencia.',hint:'Convierte "atrac√≥n" en datos concretos y medibles.'},
{text:'"Por la noche, sola, como galletas/chocolate/pan 40 min, 4 veces/semana. Despu√©s vomito." ¬øTriple sistema + par√°metros?',opts:['Motor: comer+vomitar. Cognitivo: "me siento horrible". Fisiol√≥gico: malestar. 4/sem, 40 min.','Solo motor','Solo par√°metros','No analizable'],c:0,fb:'Motor: ingesta+v√≥mito. Cognitivo: autoevaluaci√≥n negativa. Fisiol√≥gico: malestar. F: 4/sem. D: 40 min.',hint:'Busca los tres componentes y los n√∫meros.'},
{text:'"Cuando estoy sola" + "despu√©s de d√≠a estresante". ¬øFunci√≥n del atrac√≥n?',opts:['R+: placer de comer','R-: reduce malestar/estr√©s','C+: se siente mal','H√°bito sin funci√≥n'],c:1,fb:'El atrac√≥n reduce malestar acumulado = R-. El alivio inmediato (temporal) mantiene la conducta.',hint:'¬øQu√© ELIMINA el atrac√≥n?'},
{text:'¬øFunci√≥n del v√≥mito posterior?',opts:['Sin funci√≥n','R-: elimina malestar g√°strico + culpa/ansiedad','C+: auto-castigo','R+: le gusta'],c:1,fb:'Doble R-: elimina (1) malestar g√°strico y (2) culpa. Mantiene el ciclo atrac√≥n-purga.',hint:'¬øQu√© se ELIMINA tras vomitar?'}
]}
]},
{id:'D',title:'Reflexi√≥n profesional',sub:'S√≠ntesis final',typeLabel:'Integraci√≥n',instr:'Preguntas de reflexi√≥n para consolidar todo lo aprendido.',exercises:[
{type:'seq',patient:{name:'Reflexi√≥n',age:'‚Äî',gender:'m',initial:'üí°',badge:'S√≠ntesis del m√≥dulo'},quote:'Aplica todo lo aprendido a estas preguntas de integraci√≥n.',questions:[
{text:'Paciente dice "estoy mal". ¬øSecuencia correcta de preguntas?',opts:['"¬øDesde cu√°ndo? ¬øPor qu√©? ¬øQu√© sientes?"','"¬øQu√© haces/piensas/sientes? ‚Üí ¬øFrecuencia/duraci√≥n? ‚Üí ¬øEn qu√© situaciones? ‚Üí ¬øQu√© pasa despu√©s?"','"¬øDiagn√≥stico? ¬øMedicaci√≥n? ¬øAntecedentes?"','"¬øC√≥mo te sientes? ¬øQuieres hablar? ¬øQu√© puedo hacer?"'],c:1,fb:'Topograf√≠a ‚Üí Par√°metros ‚Üí Antecedentes ‚Üí Consecuencias.',hint:'Piensa en el orden: QU√â ‚Üí CU√ÅNTO ‚Üí CU√ÅNDO ‚Üí QU√â PASA.'},
{text:'¬øPor qu√© el an√°lisis funcional supera a las etiquetas?',opts:['Es m√°s moderno','Cada caso es √∫nico: misma etiqueta puede tener funciones distintas','Diagn√≥sticos est√°n mal','Es m√°s r√°pido'],c:1,fb:'Dos personas "con depresi√≥n" pueden tener contingencias distintas. La intervenci√≥n depende de la funci√≥n.',hint:'¬øQu√© pasa si tratas dos "depresiones" exactamente igual?'},
{text:'Supervisor dice: "TAG con componentes som√°ticos y cognitivos significativos." ¬øRespuesta?',opts:['"Gracias, √∫til para el tratamiento"','"Necesitamos operacionalizar: ¬øqu√© conductas, par√°metros, est√≠mulos, consecuencias?"','"¬øQu√© medicaci√≥n?"','"¬øCumple DSM?"'],c:1,fb:'Lenguaje t√©cnico vac√≠o. Para intervenir necesitamos conductas concretas, medibles, funcionalmente analizadas.',hint:'¬øEsa descripci√≥n te dice QU√â hacer en terapia?'},
{text:'Idea M√ÅS importante del m√≥dulo:',opts:['Las etiquetas son malas','La conducta se define por su FUNCI√ìN, se mide por PAR√ÅMETROS, se explica por CONTINGENCIAS','Todo se mide con n√∫meros','El AF reemplaza la entrevista'],c:1,fb:'¬°Exacto! Funci√≥n + par√°metros + contingencias = esencia del an√°lisis funcional. Tienes la base.',hint:'¬øCu√°l es el resumen de todo en una frase?'}
]}
]}
]}
};

// ===== RENDER ENGINE =====
const $=id=>document.getElementById(id);
const $app=$('app');

function go(view,opts={}){
  Object.assign(S,opts,{view});
  if(view==='exercise'){S.answers={};S.seqIdx=0;}
  saveState();render();
}

function render(){
  const v=S.view;
  if(v==='home')rHome();
  else if(v==='theory')rTheory();
  else if(v==='stages')rStages();
  else if(v==='exercise')rExercise();
  else if(v==='stage-sum')rStageSummary();
  else if(v==='level-sum')rLevelSummary();
  requestAnimationFrame(()=>{const c=$app.querySelector('.cnt');if(c)c.scrollTop=0;});
}

// ===== #16 SVG ICON HELPER =====
function ico(name,cls=''){return `<span class="ico ${cls}" style="display:inline-flex;width:1em;height:1em;vertical-align:middle">${ICO[name]||''}</span>`}

// ===== TOP BAR =====
function topBar(title,sub,back,prog){
  const dm=document.documentElement.getAttribute('data-theme')==='dark';
  let p='';if(prog!==undefined)p=`<div class="top-prog"><div class="top-prog-bar"><div class="top-prog-fill" style="width:${prog}%"></div></div><div class="top-prog-txt">${Math.round(prog)}%</div></div>`;
  return `<div class="top"><div class="top-back" onclick="${back}" tabindex="0" role="button" aria-label="Volver">${ICO.back}</div><div style="flex:1"><div class="top-t">${title}</div><div class="top-s">${sub}</div></div>${p}<div class="top-dm" onclick="toggleDark()" tabindex="0" role="button" aria-label="Modo oscuro">${dm?ICO.sun:ICO.moon}</div></div>`;
}

// ===== HOME =====
function rHome(){
  const total=6;let done=0;
  for(let i=1;i<=6;i++)if(isLvDone(i))done++;
  const pct=Math.round((done/total)*100);
  
  let lvs='';
  for(let i=1;i<=total;i++){
    const l=L[i];const d=isLvDone(i);const u=i===1||isLvDone(i-1);
    const cls=d?'done':(!u?'locked':'');
    const stars=d?'‚òÖ‚òÖ‚òÖ':(u?'‚òÜ‚òÜ‚òÜ':'üîí');
    lvs+=`<div class="lv-card ${cls}" onclick="${u?`go('theory',{level:${i},stage:0})`:'void(0)'}" tabindex="${u?0:-1}" role="button"><div class="lv-num">${d?'‚úì':i}</div><div style="flex:1"><div class="lv-name">${l.title}</div><div class="lv-sub"><span>${l.stages.length} etapas</span><span class="stars">${stars}</span></div></div><div class="lv-arrow">‚Ä∫</div></div>`;
  }
  
  $app.innerHTML=`${topBar('Fase 1 ¬∑ Fundamentos','M√≥dulo 1 de 3',"history.back()")}
  <div class="cnt">
    <div class="home-header anim">
      <div class="home-icon">${ICO.clip}</div>
      <div class="home-title">Operacionalizaci√≥n de la Conducta</div>
      <div class="home-desc">Aprende a definir conductas de forma observable, medible y funcional.</div>
    </div>
    <div style="display:flex;align-items:center;justify-content:center;gap:24px;margin-bottom:20px" class="anim d1">
      <div class="prog-ring"><svg width="80" height="80"><circle cx="40" cy="40" r="34" fill="none" stroke="var(--border)" stroke-width="6"/><circle cx="40" cy="40" r="34" fill="none" stroke="var(--gold)" stroke-width="6" stroke-dasharray="${2*Math.PI*34}" stroke-dashoffset="${2*Math.PI*34*(1-pct/100)}" stroke-linecap="round"/></svg><div class="prog-ring-txt">${pct}%</div></div>
      <div class="home-stats" style="margin:0;flex-direction:column;gap:6px"><div class="home-stat"><b>${done}/${total}</b><span>Niveles</span></div><div class="home-stat"><b>~130</b><span>Ejercicios</span></div></div>
    </div>
    <div class="ws-banner anim d2" onclick="window.open('modulo-1/talleropera.html','_blank')">
      <div class="ws-icon">${ICO.flask}</div><div style="flex:1"><div style="font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--gold-d);margin-bottom:2px">‚≠ê Herramienta pr√°ctica</div><div style="font-weight:600;font-size:15px;color:var(--bright)">Taller de Operacionalizaci√≥n</div><div style="font-size:12px;color:var(--dim)">Practica con casos abiertos</div></div><div style="font-size:18px;color:var(--gold)">‚Ä∫</div>
    </div>
    <div class="sec-title anim d3">Niveles del m√≥dulo</div>
    ${lvs}
  </div>`;
}

function isLvDone(n){const l=L[n];if(!l)return false;return l.stages.every(s=>S.scores[`${n}-${s.id}`]!==undefined);}

// ===== #4 THEORY WITH ACCORDIONS =====
function rTheory(){
  const l=L[S.level];
  let acc='';
  l.theory.forEach((t,i)=>{
    acc+=`<div class="accord ${i===0?'open':''}" onclick="this.classList.toggle('open')">
      <div class="accord-head"><div class="accord-icon" style="background:var(--${t.color}-g)">${t.icon}</div><div class="accord-title">${t.title}</div><div class="accord-arrow">‚ñº</div></div>
      <div class="accord-body"><div class="accord-inner">${t.body}</div></div></div>`;
  });
  $app.innerHTML=`${topBar(`Nivel ${S.level}`,l.title,"go('home')")}
  <div class="cnt"><div class="anim"><div class="card"><div class="tag gold">${ico('book')} Fundamento te√≥rico</div><div class="card-title">${l.title}</div><div class="card-desc">Expande cada secci√≥n para leer la teor√≠a.</div></div>${acc}</div></div>
  <div class="bot"><button class="btn btn-gold" onclick="go('stages')">Ir a los ejercicios ‚Ä∫</button></div>`;
}

// ===== #7 STAGES WITH INTENSITY CARDS =====
function rStages(){
  const l=L[S.level];
  let cards='';
  l.stages.forEach((s,i)=>{
    const done=S.scores[`${S.level}-${s.id}`]!==undefined;
    const active=i===S.stage;
    const unlocked=i===0||S.scores[`${S.level}-${l.stages[i-1].id}`]!==undefined;
    const cls=(active?'active':'')+(done?' done':'')+(!unlocked?' locked':'');
    cards+=`<div class="st-card ${cls}" data-stage="${s.id}" onclick="${unlocked?`go('stages',{stage:${i}})`:'void(0)'}"><div class="st-check">‚úì</div><div class="st-label">Etapa ${s.id}</div><div class="st-name">${s.sub}</div><div class="st-sub">${s.typeLabel}</div></div>`;
  });
  const s=l.stages[S.stage];
  $app.innerHTML=`${topBar(`Nivel ${S.level} ¬∑ Etapa ${s.id}`,s.title,"go('theory')")}
  <div class="cnt">
    <div class="stage-scroll anim">${cards}</div>
    <div class="card anim d1">
      <div class="tag ${['teal','gold','purple','purple'][S.stage]}">${ico('target')} ${s.typeLabel}</div>
      <div class="card-title">${s.title}</div>
      <div class="card-desc">${s.instr}</div>
    </div>
  </div>
  <div class="bot"><button class="btn btn-gold" onclick="startStage()">Comenzar ‚Ä∫</button></div>`;
}

function startStage(){S.exIdx=0;S.seqIdx=0;S.answers={};go('exercise');}

// ===== EXERCISE RENDERER =====
function rExercise(){
  const l=L[S.level],s=l.stages[S.stage],ex=s.exercises[S.exIdx];
  const total=getTotalQ(s),current=getCurrentQ(s);
  
  let pips='<div class="ex-prog" role="progressbar" aria-valuenow="'+current+'" aria-valuemax="'+total+'">';
  for(let i=0;i<total;i++){
    const k=ansKey(i);const ans=S.answers[k];
    let cls=i===current?'current':(ans===true?'done':(ans===false?'fail':''));
    pips+=`<div class="ex-pip ${cls}"></div>`;
  }
  pips+='</div>';
  
  let body='';
  if(ex.type==='tf')body=mkTF(ex);
  else if(ex.type==='single')body=mkSingle(ex);
  else if(ex.type==='multi')body=mkMulti(ex);
  else if(ex.type==='classify')body=mkClassify(ex);
  else if(ex.type==='order')body=mkOrder(ex);
  else if(ex.type==='seq')body=mkSeq(ex);
  
  const prog=total?Math.round((current/total)*100):0;
  $app.innerHTML=`${topBar(`Nivel ${S.level} ¬∑ Etapa ${s.id}`,s.title,"go('stages')",prog)}
  <div class="cnt">${pips}<div class="ex-wrap anim" id="exWrap">${body}</div></div>
  <div class="bot" id="botBar"></div>`;
}

function getTotalQ(s){let n=0;s.exercises.forEach(e=>{if(e.type==='seq')n+=e.questions.length;else if(e.type==='classify')n+=e.items.length;else n++});return n;}
function getCurrentQ(s){let n=0;for(let i=0;i<S.exIdx;i++){const e=s.exercises[i];if(e.type==='seq')n+=e.questions.length;else if(e.type==='classify')n+=e.items.length;else n++}const e=s.exercises[S.exIdx];if(e){if(e.type==='seq'||e.type==='classify')n+=S.seqIdx;}return n;}
function ansKey(globalIdx){return `g${globalIdx}`;}
function curAnsKey(){return ansKey(getCurrentQ(L[S.level].stages[S.stage]));}

// ===== TF =====
function mkTF(ex){
  return `<div class="card"><div class="q-num">${ico('zap')} Verdadero o Falso</div><div class="q-text">${ex.s}</div>
  <div class="tf-wrap"><div class="tf-btn" id="tfV" onclick="chkTF(true)" tabindex="0" role="button">‚úì Verdadero</div><div class="tf-btn" id="tfF" onclick="chkTF(false)" tabindex="0" role="button">‚úó Falso</div></div>
  <div class="fb" id="fb"></div></div>`;
}
function chkTF(v){
  const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
  const ok=v===ex.c;
  $('tf'+(v?'V':'F')).classList.add(ok?'correct':'wrong','disabled');
  $('tf'+(v?'F':'V')).classList.add('disabled');
  if(!ok)$(ex.c?'tfV':'tfF').classList.add('correct');
  showFB(ok,ok?ex.ok:ex.fail,ex.hint);
  record(ok);
}

// ===== SINGLE =====
function mkSingle(ex){
  let opts='';ex.opts.forEach((o,i)=>{opts+=`<div class="opt" id="so${i}" onclick="chkSingle(${i})" tabindex="0" role="button"><div class="opt-mark">${String.fromCharCode(65+i)}</div><div class="opt-txt">${o}</div></div>`});
  return `<div class="card"><div class="q-num">${ico('target')} Pregunta</div><div class="q-text">${ex.text}</div>${opts}<div class="fb" id="fb"></div></div>`;
}
function chkSingle(i){
  const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
  const ok=i===ex.c;
  document.querySelectorAll('.opt').forEach((o,j)=>{o.classList.add('disabled');if(j===i)o.classList.add(ok?'correct':'wrong');if(j===ex.c&&!ok)o.classList.add('reveal')});
  showFB(ok,ok?ex.ok:ex.fail,ex.hint);record(ok);
}

// ===== MULTI =====
let _ms=[];
function mkMulti(ex){
  _ms=[];
  let opts='';ex.opts.forEach((o,i)=>{opts+=`<div class="opt" id="mo${i}" onclick="togMulti(${i})" tabindex="0" role="button"><div class="opt-mark chk">‚òê</div><div class="opt-txt">${o}</div></div>`});
  return `<div class="card"><div class="q-num">${ico('check')} Selecciona TODAS las correctas</div><div class="q-text">${ex.text}</div>${opts}<div class="fb" id="fb"></div></div>
  <div style="text-align:center;margin-top:8px"><button class="btn btn-gold btn-sm" onclick="chkMulti()">Comprobar</button></div>`;
}
function togMulti(i){
  const el=$('mo'+i);if(el.classList.contains('disabled'))return;
  const idx=_ms.indexOf(i);
  if(idx===-1){_ms.push(i);el.classList.add('picked');el.querySelector('.opt-mark').textContent='‚òë'}
  else{_ms.splice(idx,1);el.classList.remove('picked');el.querySelector('.opt-mark').textContent='‚òê'}
}
function chkMulti(){
  const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
  const ok=JSON.stringify(_ms.sort())===JSON.stringify([...ex.c].sort());
  document.querySelectorAll('.opt').forEach((o,i)=>{o.classList.add('disabled');if(ex.c.includes(i))o.classList.add('correct');else if(_ms.includes(i))o.classList.add('wrong')});
  showFB(ok,ok?ex.ok:ex.fail,ex.hint);record(ok);_ms=[];
}

// ===== CLASSIFY =====
function mkClassify(ex){
  const e=ex.exercises?ex:ex;const item=e.items[S.seqIdx];
  let cats='';e.categories.forEach(c=>{cats+=`<div class="cl-cat" onclick="chkCl('${c}')" tabindex="0" role="button">${c}</div>`});
  return `<div class="card"><div class="q-num">${ico('target')} Clasifica ${S.seqIdx+1} de ${e.items.length}</div><div class="q-text">"${item.text}"</div><div class="cl-cats">${cats}</div><div class="fb" id="fb"></div></div>`;
}
function chkCl(cat){
  const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
  const item=ex.items[S.seqIdx];const ok=cat===item.cat;
  document.querySelectorAll('.cl-cat').forEach(c=>{c.classList.add('disabled');if(c.textContent===item.cat)c.classList.add('correct');else if(c.textContent===cat&&!ok)c.classList.add('wrong')});
  const fb=ok?`Correcto. "${item.text}" ‚Üí ${item.cat}.`:`Incorrecto. "${item.text}" ‚Üí ${item.cat}, no ${cat}.`;
  showFB(ok,fb);
  S.answers[curAnsKey()]=ok;
  if(!ok)logError(item.text,item.cat);
  setTimeout(()=>{if(S.seqIdx<ex.items.length-1){S.seqIdx++;render()}else{S.seqIdx=0;nextEx()}},1800);
}

// ===== #11 ORDER WITH UNDO =====
let _os=[];
function mkOrder(ex){
  _os=[];
  const sh=[...ex.items].map((t,i)=>({t,i})).sort(()=>Math.random()-.5);
  let pool='';sh.forEach((s,i)=>{pool+=`<div class="ord-item" id="oi${i}" data-text="${s.t}" onclick="pickOrd(${i})" tabindex="0">${s.t}</div>`});
  return `<div class="card"><div class="q-num">${ico('target')} Ordena de peor a mejor</div>
  <div class="ord-seq" id="ordSeq"></div>
  <div style="display:flex;align-items:center;margin-bottom:8px"><div class="ord-undo" id="ordUndo" onclick="undoOrd()" tabindex="0">${ICO.undo} Deshacer</div></div>
  <div class="ord-pool" id="ordPool">${pool}</div>
  <div class="fb" id="fb"></div></div>`;
}
function pickOrd(i){
  const el=$('oi'+i);if(el.classList.contains('placed'))return;
  el.classList.add('placed');_os.push({i,text:el.dataset.text});
  updOrdSeq();
  const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
  if(_os.length===ex.items.length){
    const ok=_os.every((o,j)=>o.text===ex.items[j]);
    document.querySelectorAll('.ord-placed').forEach((p,j)=>p.classList.add(_os[j].text===ex.items[j]?'correct':'wrong'));
    document.querySelectorAll('.ord-item,.ord-undo').forEach(e=>e.style.pointerEvents='none');
    showFB(ok,ok?ex.ok:ex.fail);record(ok);
  }
}
function undoOrd(){
  if(!_os.length)return;
  const last=_os.pop();$('oi'+last.i).classList.remove('placed');
  updOrdSeq();
}
function updOrdSeq(){
  const seq=$('ordSeq');
  seq.innerHTML=_os.map((o,i)=>`<div class="ord-placed"><span class="ord-n">${i+1}.</span> ${o.text}</div>`).join('');
  const u=$('ordUndo');if(u)u.classList.toggle('show',_os.length>0);
}

// ===== #5 SEQ WITH PATIENT CARDS =====
function mkSeq(ex){
  const q=ex.questions[S.seqIdx];
  let opts='';q.opts.forEach((o,i)=>{opts+=`<div class="opt" id="sq${i}" onclick="chkSeq(${i})" tabindex="0" role="button"><div class="opt-mark">${String.fromCharCode(65+i)}</div><div class="opt-txt">${o}</div></div>`});
  
  let patientHtml='';
  if(ex.patient){
    const p=ex.patient;
    patientHtml=`<div class="patient"><div class="patient-head"><div class="patient-avatar ${p.gender}">${p.initial}</div><div class="patient-meta"><div class="patient-name">${p.name}</div><div class="patient-age">${p.age}</div></div><div class="patient-badge">${p.badge}</div></div><div class="patient-quote">${ex.quote}</div></div>`;
  }
  
  return `${patientHtml}<div class="card"><div class="q-num">${ico('target')} Pregunta ${S.seqIdx+1} de ${ex.questions.length}</div><div class="q-text">${q.text}</div>${opts}<div class="fb" id="fb"></div></div>`;
}
function chkSeq(i){
  const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
  const q=ex.questions[S.seqIdx];const ok=i===q.c;
  document.querySelectorAll('.opt').forEach((o,j)=>{o.classList.add('disabled');if(j===i)o.classList.add(ok?'correct':'wrong');if(j===q.c&&!ok)o.classList.add('reveal')});
  showFB(ok,q.fb,q.hint);
  S.answers[curAnsKey()]=ok;
  if(!ok)logError(q.text,q.opts[q.c]);
  setTimeout(()=>{if(S.seqIdx<ex.questions.length-1){S.seqIdx++;render()}else{S.seqIdx=0;nextEx()}},2500);
}

// ===== #2 FEEDBACK =====
function showFB(ok,text,hint){
  const fb=$('fb');
  fb.className=`fb show ${ok?'ok':'fail'}`;
  let h='';if(!ok&&hint)h=`<div class="fb-hint show">üí° Pista: ${hint}</div>`;
  fb.innerHTML=`<b>${ok?'‚úì ¬°Correcto!':'‚úó Incorrecto'}</b>${text}${h}`;
  if(ok){fireConfetti();fb.classList.add('pulse-ok');}
  else{const w=$('exWrap');if(w){w.classList.add('shake');setTimeout(()=>w.classList.remove('shake'),500)}}
}

// ===== #19 ERROR LOG =====
function logError(q,correct){
  if(!S.errors[S.level])S.errors[S.level]={};
  const k=`${S.stage}-${S.exIdx}-${S.seqIdx}`;
  S.errors[S.level][k]={q:q.substring(0,80),a:typeof correct==='string'?correct.substring(0,80):correct};
  saveState();
}

// ===== NAVIGATION =====
function record(ok){
  S.answers[curAnsKey()]=ok;
  if(!ok){
    const ex=L[S.level].stages[S.stage].exercises[S.exIdx];
    const q=ex.text||ex.s||(ex.questions?ex.questions[S.seqIdx]?.text:'');
    const c=ex.c!==undefined?(typeof ex.c==='number'?ex.opts?.[ex.c]:''):'';
    if(q&&c)logError(q,c);
  }
  const bot=$('botBar');
  bot.innerHTML=`<button class="btn btn-gold" onclick="nextEx()">Siguiente ‚Ä∫</button>`;
}

function nextEx(){
  const s=L[S.level].stages[S.stage];
  // #20 Smooth transition
  const w=$('exWrap');
  if(w){w.classList.add('exit');setTimeout(()=>{advanceEx(s)},250)}
  else advanceEx(s);
}
function advanceEx(s){
  if(S.exIdx<s.exercises.length-1){S.exIdx++;S.seqIdx=0;render()}
  else{
    let c=0,t=0;for(const[k,v]of Object.entries(S.answers)){if(typeof v==='boolean'){t++;if(v)c++}}
    S.scores[`${S.level}-${s.id}`]={correct:c,total:t};
    saveState();go('stage-sum');
  }
}

// ===== STAGE SUMMARY =====
function rStageSummary(){
  const l=L[S.level],s=l.stages[S.stage],sc=S.scores[`${S.level}-${s.id}`];
  const pct=sc.total?Math.round((sc.correct/sc.total)*100):0;
  const cls=pct>=80?'great':(pct>=50?'ok':'low');
  const msg=pct>=80?'¬°Excelente!':(pct>=50?'Buen progreso':'Necesitas repasar');
  
  const hasNext=S.stage<l.stages.length-1;
  let nextBtn=hasNext
    ?`<button class="btn btn-gold" onclick="go('stages',{stage:${S.stage+1}})">Etapa ${l.stages[S.stage+1].id} ‚Ä∫</button>`
    :`<button class="btn btn-green" onclick="go('level-sum')">Resumen del nivel ‚Ä∫</button>`;
  
  // #19 Error review
  let errs='';
  const lvErrs=S.errors[S.level]||{};
  const stageErrs=Object.entries(lvErrs).filter(([k])=>k.startsWith(`${S.stage}-`));
  if(stageErrs.length){
    errs=`<div class="sec-title" style="margin-top:16px">‚ùå Preguntas que revisar</div>`;
    stageErrs.forEach(([k,v])=>{errs+=`<div class="review-card"><div class="review-q">${v.q}...</div><div class="review-a">‚úì ${v.a}</div></div>`});
  }
  
  $app.innerHTML=`${topBar(`Nivel ${S.level} ¬∑ Etapa ${s.id}`,'Resultados',"go('stages')")}
  <div class="cnt" style="text-align:center">
    <div class="sum-circle ${cls} anim"><div class="sum-score">${sc.correct}</div><div class="sum-total">de ${sc.total}</div></div>
    <div class="sum-msg anim d1">${msg}</div>
    <div class="sum-sub anim d2">Etapa ${s.id}: ${s.title} ‚Äî ${pct}%</div>
    ${errs}
  </div>
  <div class="bot">
    <button class="btn btn-ghost btn-icon" onclick="S.exIdx=0;S.seqIdx=0;S.answers={};delete S.scores[\`${S.level}-${s.id}\`];saveState();go('exercise')" aria-label="Repetir">üîÑ</button>
    ${nextBtn}
  </div>`;
}

// ===== #13 LEVEL SUMMARY WITH CHEATSHEET =====
function rLevelSummary(){
  const l=L[S.level];
  let tc=0,tt=0,items='';
  l.stages.forEach(s=>{
    const sc=S.scores[`${S.level}-${s.id}`];
    if(sc){tc+=sc.correct;tt+=sc.total;
      const p=Math.round((sc.correct/sc.total)*100);
      items+=`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border2)"><span style="font-size:16px">${p>=80?'‚úÖ':(p>=50?'üü°':'üî¥')}</span><span style="flex:1;font-size:14px">Etapa ${s.id}: ${s.title}</span><span style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:${p>=80?'var(--green)':(p>=50?'var(--gold-d)':'var(--red)')}">${p}%</span></div>`}
  });
  const pct=tt?Math.round((tc/tt)*100):0;
  const cls=pct>=80?'great':(pct>=50?'ok':'low');
  
  // #13 Cheatsheet
  let cheat='';
  if(l.cheat){
    cheat=`<div class="cheat"><div class="cheat-title">${ico('dl')} Conceptos clave ‚Äî Nivel ${S.level}</div>`;
    l.cheat.forEach(c=>{cheat+=`<div class="cheat-item">‚Ä¢ ${c}</div>`});
    cheat+='</div>';
  }
  
  $app.innerHTML=`${topBar(`Nivel ${S.level}`,'Resumen final',"go('home')")}
  <div class="cnt" style="text-align:center">
    <div class="anim"><div style="font-size:44px;margin-bottom:6px">${pct>=75?'üéâ':'üí™'}</div>
    <div class="sum-circle ${cls}"><div class="sum-score">${tc}</div><div class="sum-total">de ${tt}</div></div>
    <div class="sum-msg">${pct>=75?'¬°Nivel completado!':'Sigue practicando'}</div>
    <div class="sum-sub">${l.title} ‚Äî ${pct}%</div></div>
    <div class="card anim d1" style="text-align:left">${items}</div>
    <div class="anim d2" style="text-align:left">${cheat}</div>
  </div>
  <div class="bot"><button class="btn btn-ghost" onclick="go('home')">‚Üê M√≥dulo</button>${S.level<6?`<button class="btn btn-gold" onclick="go('theory',{level:${S.level+1},stage:0})">Nivel ${S.level+1} ‚Ä∫</button>`:''}</div>`;
}

// ===== #24 KEYBOARD NAVIGATION =====
document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&document.activeElement){document.activeElement.click()}
});

// ===== INIT =====
render();
</script>
</body>
</html>
