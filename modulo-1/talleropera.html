<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Taller: Operacionalizaci√≥n de la Conducta</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Space+Mono:wght@400;700&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: linear-gradient(160deg, #dff0f5 0%, #e8f4f8 30%, #edf6f0 60%, #e4f0f6 100%);
  --bg-flat: #e8f4f8;
  --card: #ffffff;
  --card-hover: #f5fbfd;
  --gold: #d4950a;
  --gold-bright: #f0b429;
  --gold-dim: #a87608;
  --gold-glow: rgba(212,149,10,0.08);
  --green: #16a34a;
  --green-bg: rgba(22,163,74,0.08);
  --teal: #0e7490;
  --teal-bg: rgba(14,116,144,0.06);
  --red: #dc2626;
  --purple: #7c3aed;
  --purple-bg: rgba(124,58,237,0.06);
  --pink: #be185d;
  --pink-bg: rgba(190,24,93,0.06);
  --text: #2c4a56;
  --text-dim: #6b8a97;
  --text-bright: #1a3340;
  --border: rgba(14,116,144,0.12);
  --r: 16px;
  --rs: 10px;
  --shadow: 0 2px 12px rgba(0,0,0,0.06);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:17px;line-height:1.65}

/* Particles */
#ptc{position:fixed;inset:0;z-index:0;pointer-events:none}

/* Layout */
.app{position:fixed;inset:0;display:flex;flex-direction:column;z-index:1}
.topbar{display:flex;align-items:center;padding:12px 16px;gap:12px;background:rgba(255,255,255,0.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);flex-shrink:0;z-index:10}
.topbar-back{width:36px;height:36px;border-radius:50%;background:var(--bg-flat);border:1px solid var(--border);color:var(--teal);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.2s}
.topbar-title{font-family:'Fraunces',serif;font-size:15px;font-weight:600;color:var(--teal)}
.topbar-sub{font-size:11px;color:var(--text-dim)}

.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px 16px 100px;-webkit-overflow-scrolling:touch}
.main::-webkit-scrollbar{width:3px}
.main::-webkit-scrollbar-thumb{background:rgba(14,116,144,0.12);border-radius:3px}

.bottom{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom));background:rgba(255,255,255,0.92);backdrop-filter:blur(16px);border-top:1px solid var(--border);z-index:10;display:flex;gap:10px}

/* Buttons */
.btn{flex:1;padding:15px 20px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:16px;font-weight:600;border:none;cursor:pointer;transition:all 0.2s;text-align:center}
.btn:active{transform:scale(0.97)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:#fff;box-shadow:0 4px 16px rgba(212,149,10,0.2)}
.btn-gold:disabled{opacity:0.35;pointer-events:none}
.btn-teal{background:linear-gradient(135deg,var(--teal),#0891b2);color:#fff;box-shadow:0 4px 16px rgba(14,116,144,0.2)}
.btn-ghost{background:var(--card);color:var(--text);border:1px solid var(--border)}
.btn-green{background:linear-gradient(135deg,var(--green),#22c55e);color:#fff}
.btn-sm{flex:none;padding:10px 18px;font-size:13px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:16px;box-shadow:var(--shadow)}

/* Step indicator */
.steps{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:24px}
.step-pip{height:6px;border-radius:3px;background:rgba(14,116,144,0.1);transition:all 0.4s}
.step-pip.done{background:var(--green)}
.step-pip.active{background:var(--gold);width:28px!important}
.step-pip.future{background:rgba(14,116,144,0.08)}

/* Phase labels */
.phase-label{font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.phase-label.teal{color:var(--teal)}
.phase-label.gold{color:var(--gold-dim)}
.phase-label.green{color:var(--green)}
.phase-label.purple{color:var(--purple)}
.phase-label.pink{color:var(--pink)}

.phase-title{font-family:'Fraunces',serif;font-size:21px;font-weight:700;color:var(--text-bright);margin-bottom:8px;line-height:1.3}
.phase-desc{font-size:15px;color:var(--text-dim);margin-bottom:16px;line-height:1.65}

/* Text input */
.text-input{width:100%;min-height:100px;padding:14px 16px;border:1.5px solid var(--border);border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:16px;color:var(--text-bright);background:rgba(14,116,144,0.03);resize:vertical;outline:none;transition:border-color 0.2s;line-height:1.65}
.text-input:focus{border-color:var(--teal)}
.text-input::placeholder{color:var(--text-dim)}

/* Category chips */
.cat-detected{background:var(--gold-glow);border:1px solid rgba(212,149,10,0.2);border-radius:var(--rs);padding:14px 16px;margin:16px 0;display:flex;align-items:center;gap:10px}
.cat-icon{font-size:24px}
.cat-text{flex:1;font-size:15px;color:var(--text-bright)}
.cat-text strong{color:var(--gold-dim)}

.cat-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.cat-chip{padding:10px 16px;border-radius:20px;font-size:13px;font-weight:500;border:1.5px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s;-webkit-user-select:none;user-select:none}
.cat-chip:active{transform:scale(0.96)}
.cat-chip.selected{border-color:var(--teal);background:var(--teal-bg);color:var(--teal);font-weight:600}
.cat-chip.em{border-color:rgba(190,24,93,0.2)}
.cat-chip.em.selected{border-color:var(--pink);background:var(--pink-bg);color:var(--pink)}
.cat-chip.cog{border-color:rgba(124,58,237,0.2)}
.cat-chip.cog.selected{border-color:var(--purple);background:var(--purple-bg);color:var(--purple)}
.cat-chip.mot{border-color:rgba(14,116,144,0.2)}
.cat-chip.mot.selected{border-color:var(--teal);background:var(--teal-bg);color:var(--teal)}
.cat-chip.inter{border-color:rgba(212,149,10,0.2)}
.cat-chip.inter.selected{border-color:var(--gold);background:var(--gold-glow);color:var(--gold-dim)}
.cat-chip.fisio{border-color:rgba(22,163,74,0.2)}
.cat-chip.fisio.selected{border-color:var(--green);background:var(--green-bg);color:var(--green)}

/* Guided question blocks */
.gq-block{margin-bottom:16px}
.gq-label{font-size:14.5px;font-weight:600;color:var(--text-bright);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.gq-hint{font-size:13px;color:var(--text-dim);font-style:italic;margin-bottom:8px}
.gq-input{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:15px;color:var(--text-bright);background:rgba(14,116,144,0.02);outline:none;transition:border-color 0.2s}
.gq-input:focus{border-color:var(--teal)}
.gq-input::placeholder{color:rgba(107,138,151,0.6)}

.gq-select-group{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.gq-select-opt{padding:9px 15px;border-radius:8px;font-size:14px;border:1.5px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s}
.gq-select-opt:active{transform:scale(0.96)}
.gq-select-opt.picked{border-color:var(--teal);background:var(--teal-bg);color:var(--teal);font-weight:600}

/* Tip blocks */
.tip{background:var(--gold-glow);border-left:3px solid var(--gold);padding:12px 14px;border-radius:0 var(--rs) var(--rs) 0;margin:14px 0;font-size:14px;color:var(--text-bright);line-height:1.65}
.tip em{color:var(--gold-dim);font-style:normal;font-weight:600}

/* Result card */
.result-section{margin-top:8px}
.result-label{font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--teal);margin-bottom:6px}
.result-original{background:rgba(220,38,38,0.04);border:1px solid rgba(220,38,38,0.12);border-radius:var(--rs);padding:14px;margin-bottom:12px;position:relative}
.result-original::before{content:'ANTES';position:absolute;top:-8px;left:12px;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--red);background:var(--card);padding:0 6px}
.result-original p{font-size:15px;color:#991b1b;font-style:italic}

.result-operationalized{background:var(--green-bg);border:1px solid rgba(22,163,74,0.15);border-radius:var(--rs);padding:14px;position:relative}
.result-operationalized::before{content:'DESPU√âS ‚Äî OPERACIONALIZADO';position:absolute;top:-8px;left:12px;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--green);background:var(--card);padding:0 6px}
.result-operationalized .ro-item{margin-bottom:10px}
.result-operationalized .ro-item:last-child{margin-bottom:0}
.result-operationalized .ro-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px}
.result-operationalized .ro-label.motor{color:var(--teal)}
.result-operationalized .ro-label.cognitivo{color:var(--purple)}
.result-operationalized .ro-label.fisiologico{color:var(--pink)}
.result-operationalized .ro-label.parametros{color:var(--gold-dim)}
.result-operationalized .ro-label.antecedente{color:#b45309}
.result-operationalized .ro-label.consecuente{color:var(--green)}
.result-operationalized .ro-text{font-size:14px;color:var(--text-bright);line-height:1.55}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:fadeUp 0.4s ease forwards}
.d1{animation-delay:0.08s;opacity:0}
.d2{animation-delay:0.16s;opacity:0}
.d3{animation-delay:0.24s;opacity:0}

/* Compare toggle */
.compare-wrap{margin-top:20px}

/* Hero */
.hero-icon{width:64px;height:64px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px;box-shadow:0 6px 24px rgba(212,149,10,0.2)}
.hero-title{font-family:'Fraunces',serif;font-size:24px;font-weight:700;color:var(--text-bright);text-align:center;margin-bottom:6px}
.hero-sub{font-size:15px;color:var(--text-dim);text-align:center;margin-bottom:24px;max-width:340px;margin-left:auto;margin-right:auto}

/* Counter badge */
.counter{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;background:var(--teal-bg);color:var(--teal);border:1px solid rgba(14,116,144,0.15)}

/* Section divider */
.divider{height:1px;background:var(--border);margin:20px 0}

/* ===== RESPONSIVE: TABLET (768px+) ===== */
@media (min-width: 768px) {
  html,body{font-size:18px}
  .app{max-width:680px;margin:0 auto;border-left:1px solid rgba(14,116,144,0.08);border-right:1px solid rgba(14,116,144,0.08);background:rgba(255,255,255,0.25)}
  .topbar{padding:14px 28px}
  .topbar-title{font-size:18px}
  .topbar-sub{font-size:13px}
  .main{padding:28px 32px 110px}
  .bottom{max-width:680px;left:50%;transform:translateX(-50%);right:auto;width:100%;padding:14px 32px;border-radius:16px 16px 0 0}
  .card{padding:24px 28px;border-radius:18px}
  .phase-title{font-size:22px}
  .phase-desc{font-size:16px}
  .hero-icon{width:76px;height:76px;font-size:38px}
  .hero-title{font-size:26px}
  .hero-sub{font-size:16px;max-width:440px}
  .text-input{font-size:16.5px;min-height:120px;padding:16px 18px}
  .cat-detected{padding:16px 18px}
  .cat-text{font-size:15.5px}
  .cat-chip{font-size:14.5px;padding:11px 18px}
  .gq-label{font-size:15px}
  .gq-hint{font-size:13.5px}
  .gq-input{font-size:15.5px;padding:14px 16px}
  .gq-select-opt{font-size:14.5px;padding:10px 16px}
  .tip{font-size:14.5px;padding:14px 18px}
  .btn{font-size:17px;padding:16px 24px}
  .result-original p{font-size:15.5px}
  .ro-label{font-size:12.5px}
  .ro-text{font-size:14.5px}
}

/* ===== RESPONSIVE: DESKTOP (1024px+) ===== */
@media (min-width: 1024px) {
  html,body{font-size:18.5px}
  .app{max-width:760px;box-shadow:0 0 60px rgba(14,116,144,0.06)}
  .topbar{padding:16px 36px}
  .topbar-title{font-size:19px}
  .topbar-back{width:40px;height:40px;font-size:20px}
  .topbar-back:hover{background:var(--bg-flat);border-color:var(--teal)}
  .main{padding:32px 40px 120px}
  .bottom{max-width:760px;padding:16px 40px}
  .card{padding:28px 36px}
  .phase-title{font-size:24px}
  .phase-desc{font-size:17px}
  .hero-icon{width:88px;height:88px;font-size:44px;border-radius:24px}
  .hero-title{font-size:28px}
  .hero-sub{font-size:17px;max-width:480px}
  .text-input{font-size:17px;min-height:140px}
  .cat-text{font-size:16px}
  .cat-chip{font-size:15px;padding:12px 20px}
  .cat-chip:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .gq-label{font-size:16px}
  .gq-hint{font-size:14px}
  .gq-input{font-size:16px}
  .gq-input:hover{border-color:rgba(14,116,144,0.25)}
  .gq-select-opt{font-size:15px}
  .gq-select-opt:hover{background:var(--teal-bg);border-color:var(--teal)}
  .tip{font-size:15px}
  .btn{font-size:17.5px;padding:17px 28px;border-radius:14px}
  .btn:hover{filter:brightness(1.05)}
  .result-original p{font-size:16px}
  .ro-label{font-size:13px}
  .ro-text{font-size:15.5px}
}

/* ===== RESPONSIVE: WIDE (1400px+) ===== */
@media (min-width: 1400px) {
  .app{max-width:820px}
  .bottom{max-width:820px}
  .main{padding:36px 48px 120px}
}
</style>
</head>
<body>
<canvas id="ptc"></canvas>

<div class="app">
  <div class="topbar">
    <div class="topbar-back" onclick="history.back()">‚Üê</div>
    <div style="flex:1">
      <div class="topbar-title">Taller de Operacionalizaci√≥n</div>
      <div class="topbar-sub">M√≥dulo 1 ¬∑ Herramienta pr√°ctica</div>
    </div>
  </div>

  <div class="main" id="main-content">
    <!-- Dynamic content -->
  </div>

  <div class="bottom" id="bottom-bar">
    <!-- Dynamic buttons -->
  </div>
</div>

<script>
// ===== PARTICLES =====
(function(){
  const c=document.getElementById('ptc'),x=c.getContext('2d');let ps=[];
  function rs(){c.width=innerWidth;c.height=innerHeight}
  addEventListener('resize',rs);rs();
  class P{constructor(){this.r()}r(){this.x=Math.random()*c.width;this.y=Math.random()*c.height;this.s=Math.random()*3+1;this.sx=(Math.random()-0.5)*0.25;this.sy=-Math.random()*0.35-0.08;this.o=Math.random()*0.45+0.12;this.p=Math.random()*Math.PI*2;this.ps=Math.random()*0.018+0.006}u(){this.x+=this.sx;this.y+=this.sy;this.p+=this.ps;if(this.y<-10){this.y=c.height+10;this.x=Math.random()*c.width}}d(){const g=Math.sin(this.p)*0.15+0.85,a=this.o*g;x.save();x.globalAlpha=a;x.shadowBlur=this.s*4;x.shadowColor='rgba(212,149,10,0.35)';x.beginPath();x.arc(this.x,this.y,this.s,0,Math.PI*2);x.fillStyle=`rgba(222,165,30,${a})`;x.fill();x.beginPath();x.arc(this.x,this.y,this.s*0.35,0,Math.PI*2);x.fillStyle=`rgba(255,220,100,${a*0.7})`;x.fill();x.restore()}}
  for(let i=0;i<24;i++)ps.push(new P);
  (function a(){x.clearRect(0,0,c.width,c.height);ps.forEach(p=>{p.u();p.d()});requestAnimationFrame(a)})()
})();

// ===== KEYWORD DATABASE =====
const CATEGORIES = {
  emocional: {
    id: 'emocional',
    label: 'Estado emocional',
    icon: 'üíô',
    chipClass: 'em',
    keywords: {
      // word: weight (1-3)
      'mal':2, 'triste':3, 'tristeza':3, 'ansioso':3, 'ansiedad':3, 'angustia':3, 'angustiado':3,
      'miedo':3, 'miedoso':2, 'asustado':2, 'p√°nico':3, 'terror':3, 'nervioso':3, 'nervios':2,
      'deprimido':3, 'depresi√≥n':3, 'vac√≠o':2, 'solo':1, 'soledad':2, 'desesperado':3,
      'agobiado':2, 'agobio':2, 'abrumado':2, 'frustrado':2, 'frustraci√≥n':2,
      'irritable':2, 'enojado':2, 'rabia':3, 'ira':3, 'furia':3, 'enfadado':2,
      'culpa':2, 'culpable':2, 'verg√ºenza':2, 'avergonzado':2,
      'preocupado':2, 'preocupaci√≥n':2, 'estresado':2, 'estr√©s':2,
      'feliz':1, 'contento':1, 'alegre':1, 'euf√≥rico':2, 'inestable':2,
      'inseguro':2, 'inseguridad':2, 'vulnerable':2, 'siento':1, 'me siento':2
    }
  },
  cognitivo: {
    id: 'cognitivo',
    label: 'Pensamiento / Verbalizaci√≥n encubierta',
    icon: 'üí≠',
    chipClass: 'cog',
    keywords: {
      'pienso':2, 'creo':1, 'pensar':2, 'pensamiento':3, 'idea':1,
      'no puedo':2, 'no sirvo':3, 'in√∫til':2, 'fracaso':2, 'fracasado':3,
      'nadie me quiere':3, 'todo sale mal':3, 'no valgo':3,
      'obsesi√≥n':3, 'obsesionado':3, 'no paro de pensar':3, 'rumiar':3, 'rumia':3,
      'me digo':2, 'voz interior':2, 'cabeza':1, 'mente':1,
      'catastr√≥fico':2, 'anticipar':2, 'preocuparme':2,
      'imagino':2, 'imaginar':2, 'visualizo':2, 'recuerdo':1,
      'interpreto':2, 'evaluaci√≥n':1, 'juicio':1
    }
  },
  motor: {
    id: 'motor',
    label: 'Conducta observable / Acci√≥n',
    icon: 'üèÉ',
    chipClass: 'mot',
    keywords: {
      'evito':3, 'evitar':3, 'evitaci√≥n':3, 'escapo':3, 'huyo':3, 'huir':3,
      'grito':3, 'gritar':3, 'golpeo':3, 'golpear':3, 'pego':3, 'peleo':2,
      'lloro':2, 'llorar':2, 'como mucho':2, 'no como':2, 'bebo':2, 'fumo':2,
      'me a√≠slo':3, 'encierro':2, 'no salgo':2, 'no hago nada':2,
      'procrastino':2, 'postergo':2, 'no duermo':2, 'insomnio':2,
      'compruebo':2, 'reviso':2, 'ritual':3, 'repetir':2,
      'discuto':2, 'discutir':2, 'pelear':2, 'agredir':3,
      'autolesi√≥n':3, 'me corto':3, 'me hago da√±o':3,
      'consumo':2, 'drogas':2, 'alcohol':2, 'atrac√≥n':3
    }
  },
  interpersonal: {
    id: 'interpersonal',
    label: 'Problema relacional / Interpersonal',
    icon: 'üë•',
    chipClass: 'inter',
    keywords: {
      'pareja':2, 'relaci√≥n':2, 'novio':1, 'novia':1, 'marido':1, 'esposa':1,
      'discusi√≥n':2, 'conflicto':2, 'pelea':2, 'me ignora':2,
      'dependencia':2, 'dependiente':2, 'celos':3, 'celoso':3,
      'rechazo':2, 'abandono':3, 'me dej√≥':2, 'separaci√≥n':2,
      'familia':1, 'padres':1, 'madre':1, 'padre':1, 'hijo':1, 'hija':1,
      'jefe':1, 'compa√±eros':1, 'trabajo':1, 'acoso':3, 'bullying':3,
      'no me entienden':2, 'me critican':2, 'presi√≥n social':2,
      'sumiso':2, 'agresivo':2, 'pasivo':1, 'manipulaci√≥n':2
    }
  },
  fisiologico: {
    id: 'fisiologico',
    label: 'Sensaci√≥n corporal / Fisiol√≥gico',
    icon: 'ü´Ä',
    chipClass: 'fisio',
    keywords: {
      'taquicardia':3, 'palpitaciones':3, 'coraz√≥n':2, 'sudor':3, 'sudoraci√≥n':3,
      'temblor':3, 'temblar':3, 'tiemblo':3, 'mareo':3, 'mareos':3,
      'nudo':2, 'est√≥mago':2, 'nudo en el est√≥mago':3, 'presi√≥n pecho':3,
      'tensi√≥n':2, 'tensi√≥n muscular':3, 'dolor':1, 'dolor de cabeza':2,
      'insomnio':2, 'fatiga':2, 'cansancio':2, 'agotamiento':2,
      'n√°useas':3, 'v√≥mito':2, 'falta de aire':3, 'ahogo':3,
      'hormigueo':2, 'entumecimiento':2, 'calor':1, 'fr√≠o':1, 'escalofr√≠os':3
    }
  }
};

// ===== GUIDED QUESTIONS PER STEP =====
const GUIDE_STEPS = [
  {
    id: 'topografia',
    phase: 'Paso 1 ‚Äî Topograf√≠a',
    phaseClass: 'teal',
    icon: 'üìπ',
    title: '¬øQu√© har√≠a visible una c√°mara?',
    desc: 'Si grab√°ramos a la persona con una c√°mara de v√≠deo, ¬øqu√© ver√≠amos exactamente? Necesitamos conductas concretas y observables.',
    tip: 'En An√°lisis Funcional, <em>operacionalizar</em> significa convertir etiquetas vagas en descripciones que dos observadores independientes podr√≠an identificar de la misma manera.',
    fields: [
      { id:'topo_motor', label:'üèÉ Componente Motor', hint:'¬øQu√© acciones observables realiza? (ej: sale corriendo, grita, se queda en cama, llama por tel√©fono 8 veces...)', type:'text' },
      { id:'topo_cognitivo', label:'üí≠ Componente Cognitivo', hint:'¬øQu√© se dice a s√≠ mismo? Verbalizaciones encubiertas con relevancia cl√≠nica (ej: "me van a despedir", "soy un in√∫til"...)', type:'text' },
      { id:'topo_fisio', label:'ü´Ä Componente Fisiol√≥gico', hint:'¬øQu√© respuestas corporales presenta? (ej: taquicardia, temblor de manos, sudoraci√≥n, nudo en el est√≥mago...)', type:'text' }
    ]
  },
  {
    id: 'parametros',
    phase: 'Paso 2 ‚Äî Par√°metros',
    phaseClass: 'gold',
    icon: 'üìä',
    title: 'Cuantifica la conducta',
    desc: 'Para que la descripci√≥n sea verdaderamente operacional, necesitamos datos medibles. Sin n√∫meros no hay l√≠nea base ni forma de evaluar cambio.',
    tip: 'Desde el An√°lisis Funcional, la topograf√≠a se mide en cuatro par√°metros: <em>ocurrencia</em> (¬øse da?), <em>frecuencia</em> (¬øcu√°ntas veces?), <em>intensidad</em> (¬øcon qu√© fuerza?) y <em>duraci√≥n</em> (¬øcu√°nto tiempo dura?).',
    fields: [
      { id:'param_freq', label:'üî¢ Frecuencia', hint:'¬øCu√°ntas veces ocurre? (ej: 3 veces por semana, todos los d√≠as, cada vez que...)', type:'text' },
      { id:'param_dur', label:'‚è± Duraci√≥n', hint:'¬øCu√°nto dura cada episodio? (ej: entre 10-15 minutos, varias horas, todo el d√≠a...)', type:'text' },
      { id:'param_int', label:'üìà Intensidad', hint:'¬øCon qu√© fuerza? Usa descriptores observables (ej: llanto que impide hablar, grito audible desde otra habitaci√≥n...)', type:'text' }
    ]
  },
  {
    id: 'antecedente',
    phase: 'Paso 3 ‚Äî Antecedentes (E‚Üí)',
    phaseClass: 'purple',
    icon: '‚¨ÖÔ∏è',
    title: '¬øQu√© ocurre justo antes?',
    desc: 'Identifica la situaci√≥n estimular antecedente. ¬øQu√© est√° presente (externo, interno o sustituto) inmediatamente antes de que aparezca la conducta?',
    tip: 'Recuerda que muchos est√≠mulos antecedentes en cl√≠nica son <em>encubiertos</em> (pensamientos anticipatorios, im√°genes, sensaciones). El lenguaje introduce gran complejidad: un pensamiento puede funcionar como E·¥∞.',
    fields: [
      { id:'ant_externo', label:'üåç Antecedente externo', hint:'¬øQu√© situaci√≥n, persona, lugar o evento est√° presente? (ej: su jefe le asigna una presentaci√≥n, est√° solo en casa de noche...)', type:'text' },
      { id:'ant_interno', label:'üß† Antecedente interno/sustituto', hint:'¬øQu√© pensamiento, imagen o sensaci√≥n precede la conducta? (ej: piensa "seguro que me sale mal", imagina la escena temida...)', type:'text' }
    ]
  },
  {
    id: 'consecuente',
    phase: 'Paso 4 ‚Äî Consecuencias (‚ÜíE)',
    phaseClass: 'green',
    icon: '‚û°Ô∏è',
    title: '¬øQu√© cambia despu√©s?',
    desc: 'Las consecuencias son lo que mantiene la conducta. Identifica qu√© se obtiene (R+), qu√© se elimina (R-), o qu√© se pierde (castigo).',
    tip: 'Preg√∫ntate: ¬øla conducta <em>produce</em> algo (R+)? ¬ø<em>elimina</em> algo aversivo (R-)? ¬øO no produce cambios (extinci√≥n)? La funci√≥n se define por el efecto sobre la conducta futura.',
    fields: [
      { id:'cons_inmediata', label:'‚ö° Consecuencia inmediata', hint:'¬øQu√© ocurre justo despu√©s de la conducta? (ej: la ansiedad baja, recibe atenci√≥n, evita la situaci√≥n temida...)', type:'text' },
      { id:'cons_funcion', label:'‚öôÔ∏è Funci√≥n probable', hint:'', type:'select', options: [
        'Reforzamiento positivo (obtiene algo)',
        'Reforzamiento negativo (elimina/reduce algo aversivo)',
        'Castigo positivo (recibe algo aversivo)',
        'Castigo negativo (pierde algo reforzante)',
        'No estoy seguro/a a√∫n'
      ]}
    ]
  }
];

// ===== APP STATE =====
let currentStep = 0; // 0=intro, 1=detect, 2=confirm, 3-6=guide steps, 7=result
let userText = '';
let detectedCategory = null;
let confirmedCategory = null;
let guideAnswers = {};

// ===== RENDER ENGINE =====
const $main = document.getElementById('main-content');
const $bottom = document.getElementById('bottom-bar');

function render() {
  if (currentStep === 0) renderIntro();
  else if (currentStep === 1) renderInput();
  else if (currentStep === 2) renderDetection();
  else if (currentStep >= 3 && currentStep <= 6) renderGuideStep(currentStep - 3);
  else if (currentStep === 7) renderResult();
}

function renderIntro() {
  $main.innerHTML = `
    <div class="anim" style="padding-top:16px">
      <div class="hero-icon">üî¨</div>
      <div class="hero-title">Taller de Operacionalizaci√≥n</div>
      <div class="hero-sub">Practica convertir descripciones vagas en formulaciones conductuales medibles y funcionales.</div>
    </div>
    <div class="card anim d1">
      <div class="phase-label gold">üìñ ¬øC√≥mo funciona?</div>
      <div style="font-size:14px;color:var(--text);line-height:1.7">
        <p style="margin-bottom:10px"><strong>1.</strong> Escribe una queja o descripci√≥n tal como la dir√≠a un paciente: <em>"Estoy mal"</em>, <em>"Mi hijo es agresivo"</em>, <em>"Tengo mucha ansiedad"</em>.</p>
        <p style="margin-bottom:10px"><strong>2.</strong> El sistema detectar√° el tipo de descripci√≥n y te pedir√° confirmar.</p>
        <p style="margin-bottom:10px"><strong>3.</strong> Luego te guiar√° paso a paso por el proceso de operacionalizaci√≥n usando el esquema <strong>E ‚Üí R ‚Üí E</strong> del An√°lisis Funcional de la Conducta.</p>
        <p><strong>4.</strong> Al final, comparar√°s tu texto original con la versi√≥n operacionalizada.</p>
      </div>
    </div>
    <div class="tip anim d2">
      <em>Principio clave:</em> No operacionalizamos el significado. Operacionalizamos la <em>conducta</em>. Por eso el proceso es siempre el mismo: topograf√≠a ‚Üí par√°metros ‚Üí antecedentes ‚Üí consecuencias.
    </div>
  `;
  $bottom.innerHTML = `<button class="btn btn-gold" onclick="currentStep=1;render()">Comenzar ‚Ä∫</button>`;
}

function renderInput() {
  const pipHtml = buildPips(-1);
  $main.innerHTML = `
    ${pipHtml}
    <div class="card anim">
      <div class="phase-label teal">‚úèÔ∏è Escribe la queja</div>
      <div class="phase-title">¬øQu√© dice el paciente?</div>
      <div class="phase-desc">Escribe una descripci√≥n tal como la dir√≠a un paciente. Puede ser vaga, emocional, coloquial... justamente eso es lo que vamos a operacionalizar.</div>
      <textarea class="text-input" id="user-input" placeholder="Ej: &quot;Estoy muy mal √∫ltimamente&quot;, &quot;Mi hijo no para de pegar a otros ni√±os&quot;, &quot;No puedo m√°s con la ansiedad&quot;..." oninput="checkInput()">${userText}</textarea>
    </div>
    <div class="tip anim d1">
      Cuanto m√°s vaga sea la descripci√≥n, m√°s interesante ser√° el ejercicio. En la cl√≠nica real, los pacientes rara vez llegan con conductas operacionalizadas.
    </div>
  `;
  $bottom.innerHTML = `
    <button class="btn btn-ghost btn-sm" onclick="currentStep=0;render()">‚Üê</button>
    <button class="btn btn-gold" id="btn-analyze" onclick="analyzeText()" disabled>Analizar ‚Ä∫</button>
  `;
  // Restore state
  const inp = document.getElementById('user-input');
  if (userText) { inp.value = userText; checkInput(); }
  inp.focus();
}

function checkInput() {
  const v = document.getElementById('user-input').value.trim();
  document.getElementById('btn-analyze').disabled = v.length < 3;
}

function analyzeText() {
  userText = document.getElementById('user-input').value.trim();
  detectedCategory = detectCategory(userText);
  currentStep = 2;
  render();
}

function detectCategory(text) {
  const lower = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const scores = {};
  
  for (const [catId, cat] of Object.entries(CATEGORIES)) {
    let score = 0;
    for (const [word, weight] of Object.entries(cat.keywords)) {
      const normWord = word.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      if (lower.includes(normWord)) {
        score += weight;
      }
    }
    scores[catId] = score;
  }
  
  // Find highest
  let best = null, bestScore = 0;
  for (const [catId, score] of Object.entries(scores)) {
    if (score > bestScore) { bestScore = score; best = catId; }
  }
  
  return bestScore > 0 ? best : null;
}

function renderDetection() {
  const pipHtml = buildPips(-1);
  let detectionHtml = '';
  
  if (detectedCategory) {
    const cat = CATEGORIES[detectedCategory];
    detectionHtml = `
      <div class="cat-detected anim">
        <div class="cat-icon">${cat.icon}</div>
        <div class="cat-text">Parece que describes un <strong>${cat.label.toLowerCase()}</strong>. ¬øEs correcto?</div>
      </div>
    `;
  } else {
    detectionHtml = `
      <div class="cat-detected anim" style="border-color:rgba(14,116,144,0.15);background:var(--teal-bg)">
        <div class="cat-icon">ü§î</div>
        <div class="cat-text">No he detectado una categor√≠a clara. <strong>Selecciona la que mejor describa lo que escribiste:</strong></div>
      </div>
    `;
  }
  
  $main.innerHTML = `
    ${pipHtml}
    <div class="card anim">
      <div class="phase-label gold">üîç Categor√≠a detectada</div>
      <div style="background:rgba(14,116,144,0.04);border-radius:var(--rs);padding:12px 14px;margin-bottom:14px;font-size:14px;color:var(--text);font-style:italic;border-left:3px solid var(--teal)">
        "${userText}"
      </div>
      ${detectionHtml}
      <div style="font-size:13px;color:var(--text-dim);margin:14px 0 8px">Selecciona o cambia la categor√≠a:</div>
      <div class="cat-options" id="cat-options">
        ${Object.entries(CATEGORIES).map(([id, cat]) => `
          <div class="cat-chip ${cat.chipClass} ${id === detectedCategory ? 'selected' : ''}" 
               data-cat="${id}" onclick="selectCategory('${id}')">
            ${cat.icon} ${cat.label}
          </div>
        `).join('')}
      </div>
    </div>
    <div class="tip anim d1">
      <em>¬øPor qu√© este paso?</em> En la cl√≠nica real, tambi√©n debemos confirmar con el paciente que estamos entendiendo correctamente su queja. Este sistema <em>h√≠brido</em> (detecci√≥n + confirmaci√≥n) replica ese proceso.
    </div>
  `;
  confirmedCategory = detectedCategory;
  $bottom.innerHTML = `
    <button class="btn btn-ghost btn-sm" onclick="currentStep=1;render()">‚Üê</button>
    <button class="btn btn-gold" id="btn-start-guide" onclick="startGuide()" ${confirmedCategory ? '' : 'disabled'}>Operacionalizar ‚Ä∫</button>
  `;
}

function selectCategory(catId) {
  confirmedCategory = catId;
  document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('selected'));
  document.querySelector(`.cat-chip[data-cat="${catId}"]`).classList.add('selected');
  document.getElementById('btn-start-guide').disabled = false;
}

function startGuide() {
  currentStep = 3;
  render();
}

function renderGuideStep(idx) {
  const step = GUIDE_STEPS[idx];
  const pipHtml = buildPips(idx);
  
  let fieldsHtml = '';
  step.fields.forEach(f => {
    const val = guideAnswers[f.id] || '';
    if (f.type === 'text') {
      fieldsHtml += `
        <div class="gq-block">
          <div class="gq-label">${f.label}</div>
          <div class="gq-hint">${f.hint}</div>
          <input class="gq-input" id="${f.id}" placeholder="Describe aqu√≠..." value="${val}" oninput="saveField('${f.id}',this.value)">
        </div>
      `;
    } else if (f.type === 'select') {
      fieldsHtml += `
        <div class="gq-block">
          <div class="gq-label">${f.label}</div>
          <div class="gq-select-group">
            ${f.options.map((opt, oi) => `
              <div class="gq-select-opt ${val === opt ? 'picked' : ''}" onclick="pickSelect('${f.id}','${opt.replace(/'/g,"\\'")}',this)">
                ${opt}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
  });
  
  $main.innerHTML = `
    ${pipHtml}
    <div class="card anim">
      <div class="phase-label ${step.phaseClass}">${step.icon} ${step.phase}</div>
      <div class="phase-title">${step.title}</div>
      <div class="phase-desc">${step.desc}</div>
      <div class="divider"></div>
      ${fieldsHtml}
    </div>
    <div class="tip anim d1">${step.tip}</div>
  `;
  
  const isLast = idx === GUIDE_STEPS.length - 1;
  $bottom.innerHTML = `
    <button class="btn btn-ghost btn-sm" onclick="currentStep=${currentStep - 1};render()">‚Üê</button>
    <button class="btn ${isLast ? 'btn-green' : 'btn-gold'}" onclick="nextGuideStep()">
      ${isLast ? 'Ver resultado ‚Ä∫' : 'Siguiente paso ‚Ä∫'}
    </button>
  `;
}

function saveField(id, val) { guideAnswers[id] = val; }
function pickSelect(id, val, el) {
  guideAnswers[id] = val;
  el.parentNode.querySelectorAll('.gq-select-opt').forEach(e => e.classList.remove('picked'));
  el.classList.add('picked');
}

function nextGuideStep() {
  if (currentStep < 6) { currentStep++; render(); }
  else { currentStep = 7; render(); }
}

function renderResult() {
  const cat = CATEGORIES[confirmedCategory];
  
  // Build operationalized result from answers
  const sections = [
    { label:'Motor', cls:'motor', val: guideAnswers.topo_motor },
    { label:'Cognitivo', cls:'cognitivo', val: guideAnswers.topo_cognitivo },
    { label:'Fisiol√≥gico', cls:'fisiologico', val: guideAnswers.topo_fisio },
    { label:'Par√°metros', cls:'parametros', val: [guideAnswers.param_freq, guideAnswers.param_dur, guideAnswers.param_int].filter(Boolean).join(' ¬∑ ') },
    { label:'Antecedentes', cls:'antecedente', val: [guideAnswers.ant_externo, guideAnswers.ant_interno].filter(Boolean).join(' | ') },
    { label:'Consecuencias', cls:'consecuente', val: [guideAnswers.cons_inmediata, guideAnswers.cons_funcion].filter(Boolean).join(' ‚Üí ') }
  ].filter(s => s.val);
  
  let resultItemsHtml = sections.map(s => `
    <div class="ro-item">
      <div class="ro-label ${s.cls}">${s.label}</div>
      <div class="ro-text">${s.val}</div>
    </div>
  `).join('');
  
  $main.innerHTML = `
    <div style="text-align:center;padding:20px 0 16px" class="anim">
      <div style="font-size:48px;margin-bottom:8px">‚úÖ</div>
      <div class="phase-title" style="text-align:center">¬°Conducta operacionalizada!</div>
      <div class="phase-desc" style="text-align:center">Compara c√≥mo lleg√≥ la queja vs. c√≥mo la has formulado t√∫.</div>
    </div>
    
    <div class="card compare-wrap anim d1">
      <div class="result-original">
        <p>"${userText}"</p>
      </div>
      <div style="text-align:center;margin:12px 0;font-size:20px">‚¨áÔ∏è</div>
      <div class="result-operationalized">
        ${resultItemsHtml || '<div class="ro-text" style="color:var(--text-dim)">No se completaron campos. Vuelve a los pasos e intenta de nuevo.</div>'}
      </div>
    </div>
    
    <div class="card anim d2">
      <div class="phase-label green">üí° Reflexi√≥n cl√≠nica</div>
      <div style="font-size:14px;color:var(--text);line-height:1.7">
        <p style="margin-bottom:10px">Observa la diferencia entre "${userText}" y tu formulaci√≥n operacionalizada. La primera es una <strong>etiqueta</strong>; la segunda es un <strong>an√°lisis funcional incipiente</strong> con conductas medibles, par√°metros cuantificables y relaciones E‚ÜíR‚ÜíE identificadas.</p>
        <p>En la pr√°ctica cl√≠nica, este proceso ocurre durante la <strong>evaluaci√≥n</strong> mediante entrevista, observaci√≥n y auto-observaci√≥n. El an√°lisis funcional completo requiere adem√°s evaluar las <strong>variables disposicionales</strong> (del entorno y del individuo).</p>
      </div>
    </div>
    
    <div class="tip anim d3">
      <em>Recuerda:</em> Cada caso se contempla como √∫nico. El an√°lisis funcional nos aporta la informaci√≥n relevante, nos gu√≠a en las variables a modificar y nos permite ajustar la intervenci√≥n al caso concreto.
    </div>
  `;
  
  $bottom.innerHTML = `
    <button class="btn btn-ghost" onclick="resetAll()">üîÑ Nuevo caso</button>
    <button class="btn btn-teal" onclick="history.back()">Volver al m√≥dulo</button>
  `;
}

function resetAll() {
  currentStep = 0;
  userText = '';
  detectedCategory = null;
  confirmedCategory = null;
  guideAnswers = {};
  render();
}

// ===== STEP PIPS =====
function buildPips(activeGuideIdx) {
  // activeGuideIdx: -1 for pre-guide steps, 0-3 for guide steps
  const labels = ['Topograf√≠a', 'Par√°metros', 'Antecedentes', 'Consecuencias'];
  let html = '<div class="steps">';
  for (let i = 0; i < 4; i++) {
    let cls = 'step-pip';
    let w = '20px';
    if (activeGuideIdx === i) { cls += ' active'; w = '28px'; }
    else if (i < activeGuideIdx) { cls += ' done'; }
    else { cls += ' future'; }
    html += `<div class="${cls}" style="width:${w}" title="${labels[i]}"></div>`;
  }
  html += '</div>';
  return activeGuideIdx >= 0 ? html : '';
}

// ===== INIT =====
render();
</script>
</body>
</html>
